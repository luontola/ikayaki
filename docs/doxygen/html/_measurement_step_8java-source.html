<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Squid: My Documents/squid/src/ikayaki/MeasurementStep.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">My Documents</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">squid</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">ikayaki</a></div>
<h1>MeasurementStep.java</h1><a href="_measurement_step_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * MeasurementStep.java</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright (C) 2005 Project SQUID, http://www.cs.helsinki.fi/group/squid/</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This file is part of Ikayaki.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ikayaki is free software; you can redistribute it and/or modify</span>
00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00011 <span class="comment"> * (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Ikayaki is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> * along with Ikayaki; if not, write to the Free Software</span>
00020 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="keyword">package </span>ikayaki;
00024 
00025 <span class="keyword">import</span> org.w3c.dom.Document;
00026 <span class="keyword">import</span> org.w3c.dom.Element;
00027 <span class="keyword">import</span> org.w3c.dom.NodeList;
00028 
00029 <span class="keyword">import</span> javax.vecmath.Matrix3d;
00030 <span class="keyword">import</span> javax.vecmath.Vector3d;
00031 <span class="keyword">import</span> java.util.ArrayList;
00032 <span class="keyword">import</span> java.util.Date;
00033 <span class="keyword">import</span> java.util.Iterator;
00034 <span class="keyword">import</span> java.util.List;
00035 
00036 <span class="keyword">import</span> <span class="keyword">static</span> ikayaki.MeasurementStep.State.*;
00037 
<a name="l00048"></a><a class="code" href="classikayaki_1_1_measurement_step.html">00048</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1_measurement_step.html">MeasurementStep</a> <span class="keyword">implements</span> Iterable&lt;MeasurementResult&gt; {
00049 
<a name="l00053"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r0">00053</a>     <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a>;
00054 
<a name="l00058"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r1">00058</a>     <span class="keyword">private</span> <a class="code" href="classikayaki_1_1_measurement_step.html#w1">State</a> <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> = <a class="code" href="classikayaki_1_1_measurement_step.html#w1">State</a>.READY;
00059 
<a name="l00064"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r2">00064</a>     <span class="keyword">private</span> Date <a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00065 
<a name="l00070"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r3">00070</a>     <span class="keyword">private</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r3">stepValue</a> = -1.0;
00071 
<a name="l00075"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r4">00075</a>     <span class="keyword">private</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r4">mass</a> = -1.0;
00076 
<a name="l00080"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r5">00080</a>     <span class="keyword">private</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r5">volume</a> = -1.0;
00081 
<a name="l00086"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r6">00086</a>     <span class="keyword">private</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r6">susceptibility</a> = -1.0;
00087 
<a name="l00091"></a><a class="code" href="classikayaki_1_1_measurement_step.html#r7">00091</a>     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MeasurementResult&gt; <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a> = <span class="keyword">new</span> ArrayList&lt;MeasurementResult&gt;();
00092 
<a name="l00096"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a0">00096</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a0">MeasurementStep</a>() {
00097         <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a> = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00098     }
00099 
<a name="l00105"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a1">00105</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a0">MeasurementStep</a>(<a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a>) {
00106         <span class="keyword">this</span>.project = project;
00107     }
00108 
<a name="l00116"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a2">00116</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a0">MeasurementStep</a>(Element element) {
00117         <span class="keyword">this</span>(element, <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>);
00118     }
00119 
<a name="l00128"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a3">00128</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a0">MeasurementStep</a>(Element element, <a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a>) {
00129         <span class="keywordflow">if</span> (element == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00130             <span class="keywordflow">throw</span> <span class="keyword">new</span> NullPointerException();
00131         }
00132         <span class="keyword">this</span>.project = project;
00133         String s;
00134 
00135         <span class="comment">// verify tag name</span>
00136         <span class="keywordflow">if</span> (!element.getTagName().equals(<span class="stringliteral">"step"</span>)) {
00137             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Invalid tag name: "</span> + element.getTagName());
00138         }
00139         
00140         <span class="comment">// get stepValue, mass, volume</span>
00141         s = element.getAttribute(<span class="stringliteral">"stepvalue"</span>);
00142         <span class="keywordflow">try</span> {
00143             <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r3">stepValue</a> = Double.parseDouble(s);
00144             <span class="keywordflow">if</span> (element.getAttribute(<span class="stringliteral">"done"</span>).equals(<span class="stringliteral">"1"</span>)) {
00145                 <span class="keywordflow">if</span> (stepValue &lt; 0.0) {
00146                     stepValue = -1.0;
00147                 }
00148                 <span class="keyword">this</span>.stepValue = stepValue;     <span class="comment">// for completed steps, bypass the degausser limits</span>
00149             } <span class="keywordflow">else</span> {
00150                 <a class="code" href="classikayaki_1_1_measurement_step.html#a10">setStepValue</a>(stepValue);
00151             }
00152         } <span class="keywordflow">catch</span> (NumberFormatException e) {
00153             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Invalid stepvalue: "</span> + s, e);
00154         }
00155         s = element.getAttribute(<span class="stringliteral">"mass"</span>);
00156         <span class="keywordflow">try</span> {
00157             <a class="code" href="classikayaki_1_1_measurement_step.html#a12">setMass</a>(Double.parseDouble(s));
00158         } <span class="keywordflow">catch</span> (NumberFormatException e) {
00159             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Invalid mass: "</span> + s, e);
00160         }
00161         s = element.getAttribute(<span class="stringliteral">"volume"</span>);
00162         <span class="keywordflow">try</span> {
00163             <a class="code" href="classikayaki_1_1_measurement_step.html#a14">setVolume</a>(Double.parseDouble(s));
00164         } <span class="keywordflow">catch</span> (NumberFormatException e) {
00165             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Invalid volume: "</span> + s, e);
00166         }
00167         s = element.getAttribute(<span class="stringliteral">"susceptibility"</span>);
00168         <span class="keywordflow">try</span> {
00169             <a class="code" href="classikayaki_1_1_measurement_step.html#a16">setSusceptibility</a>(Double.parseDouble(s));
00170         } <span class="keywordflow">catch</span> (NumberFormatException e) {
00171             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Invalid susceptibility: "</span> + s, e);
00172         }
00173 
00174         <span class="comment">// get results</span>
00175         NodeList <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a> = element.getElementsByTagName(<span class="stringliteral">"result"</span>);
00176         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; results.getLength(); i++) {
00177             Element result = (Element) results.item(i);
00178             <span class="keyword">this</span>.results.add(<span class="keyword">new</span> <a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a>(result));
00179         }
00180 
00181         <span class="comment">// get state, must be done after getting results</span>
00182         <span class="keywordflow">if</span> (element.getAttribute(<span class="stringliteral">"done"</span>).equals(<span class="stringliteral">"1"</span>)) {
00183             <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> = DONE;
00184         } <span class="keywordflow">else</span> {
00185             <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> = READY;
00186         }
00187 
00188         <span class="comment">// get timestamp, must be done after getting results</span>
00189         s = element.getAttribute(<span class="stringliteral">"timestamp"</span>);
00190         <span class="keywordflow">if</span> (s.equals(<span class="stringliteral">""</span>)) {
00191             <a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00192         } <span class="keywordflow">else</span> {
00193             <span class="keywordflow">try</span> {
00194                 <a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> = <span class="keyword">new</span> Date(Long.parseLong(s));
00195             } <span class="keywordflow">catch</span> (NumberFormatException e) {
00196                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Invalid timestamp: "</span> + s, e);
00197             }
00198         }
00199 
00200         <span class="comment">// check that state, timestamp and results are consistent</span>
00201         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>.isDone()) {
00202             <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> || <span class="keyword">this</span>.results.size() == 0) {
00203                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Inconsistent state"</span>);
00204             }
00205         } <span class="keywordflow">else</span> {
00206             <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> || <span class="keyword">this</span>.results.size() &gt; 0) {
00207                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"Inconsistent state"</span>);
00208             }
00209         }
00210 
00211         <span class="comment">// finalize</span>
00212         <a class="code" href="classikayaki_1_1_measurement_step.html#b0">updateTransforms</a>();
00213     }
00214 
<a name="l00220"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a4">00220</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> Element <a class="code" href="classikayaki_1_1_measurement_step.html#a4">getElement</a>(Document document) {
00221         Element element = document.createElement(<span class="stringliteral">"step"</span>);
00222 
00223         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>.size() == 0) {
00224             element.setAttribute(<span class="stringliteral">"done"</span>, <span class="stringliteral">"0"</span>);
00225             element.setAttribute(<span class="stringliteral">"timestamp"</span>, <span class="stringliteral">""</span>);
00226         } <span class="keywordflow">else</span> {
00227             element.setAttribute(<span class="stringliteral">"done"</span>, <span class="stringliteral">"1"</span>);
00228             element.setAttribute(<span class="stringliteral">"timestamp"</span>, Long.toString(<a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a>.getTime()));
00229         }
00230         element.setAttribute(<span class="stringliteral">"stepvalue"</span>, Double.toString(<a class="code" href="classikayaki_1_1_measurement_step.html#r3">stepValue</a>));
00231         element.setAttribute(<span class="stringliteral">"mass"</span>, Double.toString(<a class="code" href="classikayaki_1_1_measurement_step.html#r4">mass</a>));
00232         element.setAttribute(<span class="stringliteral">"volume"</span>, Double.toString(<a class="code" href="classikayaki_1_1_measurement_step.html#r5">volume</a>));
00233         element.setAttribute(<span class="stringliteral">"susceptibility"</span>, Double.toString(<a class="code" href="classikayaki_1_1_measurement_step.html#r6">susceptibility</a>));
00234 
00235         <span class="keywordflow">for</span> (<a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> result : <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>) {
00236             element.appendChild(result.getElement(document));
00237         }
00238 
00239         <span class="keywordflow">return</span> element;
00240     }
00241 
<a name="l00245"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a5">00245</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>() {
00246         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a> != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00247             <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a>.<a class="code" href="classikayaki_1_1_project.html#a2">save</a>();
00248         }
00249     }
00250 
<a name="l00254"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a6">00254</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>() {
00255         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a>;
00256     }
00257 
<a name="l00261"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a7">00261</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <a class="code" href="classikayaki_1_1_measurement_step.html#w1">State</a> <a class="code" href="classikayaki_1_1_measurement_step.html#a7">getState</a>() {
00262         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>;
00263     }
00264 
<a name="l00268"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a8">00268</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> Date <a class="code" href="classikayaki_1_1_measurement_step.html#a8">getTimestamp</a>() {
00269         <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>.isDone()) {
00270             <span class="keywordflow">return</span> <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00271         }
00272         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00273             <span class="keywordflow">return</span> <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00274         } <span class="keywordflow">else</span> {
00275             <span class="keywordflow">return</span> (Date) <a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a>.clone();
00276         }
00277     }
00278 
<a name="l00283"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a9">00283</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a9">getStepValue</a>() {
00284         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r3">stepValue</a>;
00285     }
00286 
<a name="l00293"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a10">00293</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a10">setStepValue</a>(<span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r3">stepValue</a>) {
00294         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> != READY) {
00295             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="stringliteral">"Unable to set stepValue, state is: "</span> + <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>);
00296         }
00297         <span class="keywordflow">if</span> (stepValue &lt; 0.0) {
00298             stepValue = -1.0;
00299         }
00300         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>() != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> &amp;&amp; <a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>().getType() == <a class="code" href="classikayaki_1_1_project.html">Project</a>.Type.AF) {
00301             <span class="keywordflow">if</span> (stepValue &gt; 0.0 &amp;&amp; stepValue &lt; <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getDegausserMinimumField()) {
00302                 stepValue = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getDegausserMinimumField();
00303             }
00304             stepValue = Math.min(stepValue, <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getDegausserMaximumField());
00305         }
00306         <span class="keyword">this</span>.stepValue = stepValue;
00307         <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00308     }
00309 
<a name="l00314"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a11">00314</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a11">getMass</a>() {
00315         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r4">mass</a>;
00316     }
00317 
<a name="l00321"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a12">00321</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a12">setMass</a>(<span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r4">mass</a>) {
00322         <span class="keywordflow">if</span> (mass &lt; 0.0) {
00323             mass = -1.0;
00324         }
00325         <span class="keyword">this</span>.mass = mass;
00326         <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00327     }
00328 
<a name="l00333"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a13">00333</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a13">getVolume</a>() {
00334         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r5">volume</a>;
00335     }
00336 
<a name="l00340"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a14">00340</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a14">setVolume</a>(<span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r5">volume</a>) {
00341         <span class="keywordflow">if</span> (volume &lt; 0.0) {
00342             volume = -1.0;
00343         }
00344         <span class="keyword">this</span>.volume = volume;
00345         <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00346     }
00347 
<a name="l00352"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a15">00352</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a15">getSusceptibility</a>() {
00353         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r6">susceptibility</a>;
00354     }
00355 
<a name="l00359"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a16">00359</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a16">setSusceptibility</a>(<span class="keywordtype">double</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r6">susceptibility</a>) {
00360         <span class="keywordflow">if</span> (susceptibility &lt; 0.0) {
00361             susceptibility = -1.0;
00362         }
00363         <span class="keyword">this</span>.susceptibility = susceptibility;
00364         <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00365     }
00366 
<a name="l00371"></a><a class="code" href="classikayaki_1_1_measurement_step.html#b0">00371</a>     <span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#b0">updateTransforms</a>() {
00372         Matrix3d transform = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00373         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a> != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00374             transform = <a class="code" href="classikayaki_1_1_measurement_step.html#r0">project</a>.<a class="code" href="classikayaki_1_1_project.html#b0">getTransform</a>();
00375         }
00376         <span class="keywordflow">for</span> (<a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> result : <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>) {
00377             result.applyFixes(<span class="keyword">this</span>);
00378             result.setTransform(transform);
00379         }
00380     }
00381 
<a name="l00385"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a17">00385</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a17">getResults</a>() {
00386         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>.size();
00387     }
00388 
<a name="l00396"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a18">00396</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> <a class="code" href="classikayaki_1_1_measurement_step.html#a18">getResult</a>(<span class="keywordtype">int</span> index) {
00397         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>.get(index);
00398     }
00399 
<a name="l00411"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a19">00411</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a19">addResult</a>(<a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> result) {
00412         <span class="keywordflow">if</span> (result == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00413             <span class="keywordflow">throw</span> <span class="keyword">new</span> NullPointerException();
00414         }
00415         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>.isDone()) {
00416             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="stringliteral">"Unable to add results, state is: "</span> + <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>);
00417         }
00418 
00419         <a class="code" href="classikayaki_1_1_measurement_step.html#a20">setMeasuring</a>();
00420         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>.size() == 0 &amp;&amp; (<a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>() == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> || !<a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>().isHolderCalibration())) {
00421             <span class="comment">// holder calibration value for all except the holder calibration project itself</span>
00422             <a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> holder = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHolderCalibration();
00423             <span class="keywordflow">if</span> (holder != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00424                 <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>.add(holder);
00425             }
00426         }
00427         <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>.add(result);
00428         <a class="code" href="classikayaki_1_1_measurement_step.html#r2">timestamp</a> = <span class="keyword">new</span> Date();
00429         <a class="code" href="classikayaki_1_1_measurement_step.html#b0">updateTransforms</a>();
00430         <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00431     }
00432 
<a name="l00438"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a20">00438</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a20">setMeasuring</a>() {
00439         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>.isDone()) {
00440             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="stringliteral">"Unable set state to MEASURING, state is: "</span> + <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>);
00441         }
00442         <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> = MEASURING;
00443         <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00444     }
00445 
<a name="l00451"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a21">00451</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_measurement_step.html#a21">setDone</a>() {
00452         <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a>.isDone()) {
00453             <span class="comment">// if the measurement was aborted before any steps were measured, return to an unmeasured state</span>
00454             <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#a17">getResults</a>() == 0) {
00455                 <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> = READY;
00456             } <span class="keywordflow">else</span> {
00457                 <a class="code" href="classikayaki_1_1_measurement_step.html#r1">state</a> = DONE_RECENTLY;
00458             }
00459             <a class="code" href="classikayaki_1_1_measurement_step.html#b0">updateTransforms</a>();     <span class="comment">// need to update NOISE fixes</span>
00460             <a class="code" href="classikayaki_1_1_measurement_step.html#a5">save</a>();
00461         }
00462     }
00463 
<a name="l00468"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a22">00468</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> Vector3d <a class="code" href="classikayaki_1_1_measurement_step.html#a22">getHolder</a>() {
00469         Vector3d v = <span class="keyword">new</span> Vector3d();
00470         <span class="keywordtype">int</span> count = 0;
00471         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>() != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> &amp;&amp; <a class="code" href="classikayaki_1_1_measurement_step.html#a6">getProject</a>().isHolderCalibration()) {
00472             <span class="keywordflow">return</span> v;
00473         }
00474         <span class="keywordflow">for</span> (<a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> result : <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>) {
00475             <span class="keywordflow">if</span> (result.getType() != <a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a>.Type.HOLDER) {
00476                 <span class="keywordflow">continue</span>;
00477             }
00478             <span class="comment">// all rotations are assumed to be 0</span>
00479             <span class="comment">// TODO: find out where and when the holder's noise fix is done. it should be before we can return from this method.</span>
00480             v.add(result.getRawVector());
00481             count++;
00482         }
00483         <span class="keywordflow">if</span> (count &gt; 0) {
00484             v.scale(1.0 / count);
00485         }
00486         <span class="keywordflow">return</span> v;
00487     }
00488 
<a name="l00493"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a23">00493</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> Vector3d <a class="code" href="classikayaki_1_1_measurement_step.html#a23">getNoise</a>() {
00494         Vector3d v = <span class="keyword">new</span> Vector3d();
00495         <span class="keywordtype">int</span> count = 0;
00496         <span class="keywordflow">for</span> (<a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> result : <a class="code" href="classikayaki_1_1_measurement_step.html#r7">results</a>) {
00497             <span class="keywordflow">if</span> (result.getType() != <a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a>.Type.NOISE) {
00498                 <span class="keywordflow">continue</span>;
00499             }
00500             <span class="comment">// all rotations are assumed to be 0</span>
00501             v.add(result.getRawVector());
00502             count++;
00503         }
00504         <span class="keywordflow">if</span> (count &gt; 0) {
00505             v.scale(1.0 / count);
00506         }
00507         <span class="keywordflow">return</span> v;
00508     }
00509 
<a name="l00513"></a><a class="code" href="classikayaki_1_1_measurement_step.html#a24">00513</a>     <span class="keyword">public</span> Iterator&lt;MeasurementResult&gt; <a class="code" href="classikayaki_1_1_measurement_step.html#a24">iterator</a>() {
00514         <span class="keyword">final</span> <a class="code" href="classikayaki_1_1_measurement_step.html">MeasurementStep</a> step = <span class="keyword">this</span>;
00515 
00516         <span class="keywordflow">return</span> <span class="keyword">new</span> Iterator&lt;MeasurementResult&gt;() {
00517 
00518             <span class="keyword">private</span> <span class="keywordtype">int</span> next = 0;
00519 
00520             <span class="keyword">public</span> <span class="keywordtype">boolean</span> hasNext() {
00521                 <span class="keywordflow">return</span> next &lt; step.<a class="code" href="classikayaki_1_1_measurement_step.html#a17">getResults</a>();
00522             }
00523 
00524             <span class="keyword">public</span> <a class="code" href="classikayaki_1_1_measurement_result.html">MeasurementResult</a> next() {
00525                 <span class="keywordflow">return</span> step.<a class="code" href="classikayaki_1_1_measurement_step.html#a18">getResult</a>(next++);
00526             }
00527 
00528             <span class="keyword">public</span> <span class="keywordtype">void</span> remove() {
00529                 <span class="keywordflow">throw</span> <span class="keyword">new</span> UnsupportedOperationException();
00530             }
00531         };
00532     }
00533 
<a name="l00537"></a><a class="code" href="classikayaki_1_1_measurement_step.html#w1">00537</a>     <span class="keyword">public</span> <span class="keyword">enum</span> <a class="code" href="classikayaki_1_1_measurement_step.html#w1">State</a> {
00538         READY(<span class="keyword">false</span>), MEASURING(<span class="keyword">false</span>), DONE_RECENTLY(<span class="keyword">true</span>), DONE(<span class="keyword">true</span>);
00539 
00540         <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1_measurement_step.html#w1">done</a>;
00541 
00542         <span class="keyword">private</span> <a class="code" href="classikayaki_1_1_measurement_step.html#w1">State</a>(<span class="keywordtype">boolean</span> done) {
00543             <span class="keyword">this</span>.done = done;
00544         }
00545 
00549         <span class="keyword">public</span> <span class="keywordtype">boolean</span> isDone() {
00550             <span class="keywordflow">return</span> done;
00551         }
00552     }
00553 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed May 4 13:11:04 2005 for Squid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
