<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Squid: My Documents/squid/src/ikayaki/Ikayaki.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">My Documents</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">squid</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">ikayaki</a></div>
<h1>Ikayaki.java</h1><a href="_ikayaki_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * Ikayaki.java</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright (C) 2005 Project SQUID, http://www.cs.helsinki.fi/group/squid/</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This file is part of Ikayaki.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ikayaki is free software; you can redistribute it and/or modify</span>
00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00011 <span class="comment"> * (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Ikayaki is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> * along with Ikayaki; if not, write to the Free Software</span>
00020 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="keyword">package </span>ikayaki;
00024 
00025 <span class="keyword">import</span> com.jgoodies.looks.plastic.Plastic3DLookAndFeel;
00026 <span class="keyword">import</span> com.jgoodies.looks.plastic.PlasticLookAndFeel;
00027 <span class="keyword">import</span> com.jgoodies.looks.plastic.theme.SkyBlue;
00028 <span class="keyword">import</span> ikayaki.gui.MainViewPanel;
00029 <span class="keyword">import</span> ikayaki.util.LoggerPrintStream;
00030 <span class="keyword">import</span> jutil.JUtil;
00031 
00032 <span class="keyword">import</span> javax.swing.*;
00033 <span class="keyword">import</span> java.awt.*;
00034 <span class="keyword">import</span> java.awt.event.*;
00035 <span class="keyword">import</span> java.io.File;
00036 <span class="keyword">import</span> java.io.FileNotFoundException;
00037 <span class="keyword">import</span> java.io.FileOutputStream;
00038 <span class="keyword">import</span> java.io.PrintStream;
00039 <span class="keyword">import</span> java.util.Date;
00040 
<a name="l00046"></a><a class="code" href="classikayaki_1_1_ikayaki.html">00046</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a> <span class="keyword">extends</span> JFrame {
00047 
00048     <span class="comment">/* Application information */</span>
00049 
<a name="l00050"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s0">00050</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s0">APP_NAME</a> = <span class="stringliteral">"Ikayaki"</span>;
<a name="l00051"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s1">00051</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s1">APP_VERSION</a> = <span class="stringliteral">"0.92"</span>;
<a name="l00052"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s2">00052</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s2">APP_BUILD</a> = <span class="stringliteral">"2005-04-xx"</span>;
<a name="l00053"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s3">00053</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s3">APP_HOME_PAGE</a> = <span class="stringliteral">"http://www.cs.helsinki.fi/group/squid/"</span>;
00054 
<a name="l00055"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s4">00055</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s4">FILE_TYPE</a> = <span class="stringliteral">".ika"</span>;
<a name="l00056"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s5">00056</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s5">FILE_DESCRIPTION</a> = <span class="stringliteral">"Measurement Project"</span>;
00057 
<a name="l00058"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s6">00058</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] <a class="code" href="classikayaki_1_1_ikayaki.html#s6">AUTHORS</a> = <span class="keyword">new</span> String[]{
00059         <span class="stringliteral">"Mikko Jormalainen"</span>,
00060         <span class="stringliteral">"Samuli Kaipiainen"</span>,
00061         <span class="stringliteral">"Aki Korpua"</span>,
00062         <span class="stringliteral">"Esko Luontola"</span>,
00063         <span class="stringliteral">"Aki Sysmäläinen"</span>
00064     };
00065 
00066     <span class="comment">/* Application files and directories */</span>
00067 
<a name="l00068"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s7">00068</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> File <a class="code" href="classikayaki_1_1_ikayaki.html#s7">STARTUP_DIRECTORY</a> = <span class="keyword">new</span> File(System.getProperty(<span class="stringliteral">"user.dir"</span>)).getAbsoluteFile();
<a name="l00069"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s8">00069</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s8">PROGRAM_JAR_NAME</a> = <span class="stringliteral">"ikayaki.jar"</span>;
00070 
00071     <span class="keyword">static</span> {
00072         <span class="comment">// change to the program directory if it was started somewhere else</span>
00073         String[] paths = System.getProperty(<span class="stringliteral">"java.class.path"</span>).split(System.getProperty(<span class="stringliteral">"path.separator"</span>));
00074         <span class="keywordflow">for</span> (String s : paths) {
00075             File file = <span class="keyword">new</span> File(s);
00076             <span class="keywordflow">if</span> (file.getName().equals(<a class="code" href="classikayaki_1_1_ikayaki.html#s8">PROGRAM_JAR_NAME</a>)) {
00077                 file = file.getAbsoluteFile();
00078                 System.setProperty(<span class="stringliteral">"user.dir"</span>, file.getParent());
00079                 <span class="keywordflow">break</span>;
00080             }
00081         }
00082     }
00083 
<a name="l00084"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s9">00084</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> File <a class="code" href="classikayaki_1_1_ikayaki.html#s9">PROPERTIES_FILE</a> = <span class="keyword">new</span> File(<span class="stringliteral">"ikayaki.config"</span>).getAbsoluteFile();
<a name="l00085"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s10">00085</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> File <a class="code" href="classikayaki_1_1_ikayaki.html#s10">SEQUENCES_FILE</a> = <span class="keyword">new</span> File(<span class="stringliteral">"ikayaki.sequences"</span>).getAbsoluteFile();
<a name="l00086"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s11">00086</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> File <a class="code" href="classikayaki_1_1_ikayaki.html#s11">CALIBRATION_PROJECT_DIR</a> = <span class="keyword">new</span> File(<span class="stringliteral">"calibration"</span>).getAbsoluteFile();
<a name="l00087"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s12">00087</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> File <a class="code" href="classikayaki_1_1_ikayaki.html#s12">DEBUG_LOG_DIR</a> = <span class="keyword">new</span> File(<span class="stringliteral">"logs"</span>).getAbsoluteFile();
<a name="l00088"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s13">00088</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> File <a class="code" href="classikayaki_1_1_ikayaki.html#s13">DEBUG_LOG_FILE</a> = <span class="keyword">new</span> File(<span class="stringliteral">"debug.log"</span>).getAbsoluteFile();
<a name="l00089"></a><a class="code" href="classikayaki_1_1_ikayaki.html#s14">00089</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <a class="code" href="classikayaki_1_1_ikayaki.html#s14">HELP_PAGES</a> = <span class="keyword">new</span> File(<span class="stringliteral">"manual/index.html"</span>).getAbsolutePath();
00090 
<a name="l00097"></a><a class="code" href="classikayaki_1_1_ikayaki.html#e0">00097</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_ikayaki.html#e0">main</a>(String[] args) {
00098 
00099         <span class="comment">// clean up log files</span>
00100         <a class="code" href="classikayaki_1_1_ikayaki.html#h0">logFileCleanup</a>(<a class="code" href="classikayaki_1_1_ikayaki.html#s13">DEBUG_LOG_FILE</a>, 1024 * 1024, 5);
00101         <a class="code" href="classikayaki_1_1_ikayaki.html#h1">logDirCleanup</a>(<a class="code" href="classikayaki_1_1_ikayaki.html#s12">DEBUG_LOG_DIR</a>, 30);
00102 
00103         <span class="comment">// redirect a copy of System.err to a file</span>
00104         <span class="keywordflow">try</span> {
00105             String message = <span class="stringliteral">"\n\n----- "</span> + <a class="code" href="classikayaki_1_1_ikayaki.html#s0">APP_NAME</a> + <span class="stringliteral">" "</span> + <a class="code" href="classikayaki_1_1_ikayaki.html#s1">APP_VERSION</a>
00106                     + <span class="stringliteral">" started on "</span> + <span class="keyword">new</span> Date().toString() + <span class="stringliteral">" -----"</span>;
00107             PrintStream logger = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1util_1_1_logger_print_stream.html">LoggerPrintStream</a>(<span class="keyword">new</span> FileOutputStream(<a class="code" href="classikayaki_1_1_ikayaki.html#s13">DEBUG_LOG_FILE</a>, <span class="keyword">true</span>), System.err, message);
00108             System.setErr(logger);
00109 
00110         } <span class="keywordflow">catch</span> (FileNotFoundException e) {
00111             System.err.println(<span class="stringliteral">"Unable to write to: "</span> + <a class="code" href="classikayaki_1_1_ikayaki.html#s13">DEBUG_LOG_FILE</a>);
00112         }
00113 
00114         <span class="comment">// read input parameters and load the optional project file</span>
00115         <a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="namespaceikayaki_1_1gui.html#a26a1">project</a> = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00116         <span class="keywordflow">if</span> (args.length &gt; 0) {
00117             File file = <span class="keyword">new</span> File(args[0]);
00118             <span class="keywordflow">if</span> (!file.isAbsolute()) {
00119                 file = <span class="keyword">new</span> File(<a class="code" href="classikayaki_1_1_ikayaki.html#s7">STARTUP_DIRECTORY</a>, file.getPath());
00120             }
00121             <span class="keywordflow">if</span> (file.exists() &amp;&amp; file.isFile()) {
00122                 project = <a class="code" href="classikayaki_1_1_project.html">Project</a>.<a class="code" href="classikayaki_1_1_project.html#e5">loadProject</a>(file.getAbsoluteFile());
00123             }
00124         }
00125 
00126         <span class="comment">// the program must be started in the event dispatch thread</span>
00127         <span class="keyword">final</span> <a class="code" href="classikayaki_1_1_project.html">Project</a> p = project;
00128         SwingUtilities.invokeLater(<span class="keyword">new</span> Runnable() {
00129             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00130                 <span class="keyword">new</span> <a class="code" href="classikayaki_1_1_ikayaki.html#a0">Ikayaki</a>(p);
00131             }
00132         });
00133     }
00134 
<a name="l00143"></a><a class="code" href="classikayaki_1_1_ikayaki.html#h0">00143</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_ikayaki.html#h0">logFileCleanup</a>(File logFile, <span class="keywordtype">long</span> maxLength, <span class="keywordtype">int</span> maxFiles) {
00144         <span class="keywordflow">if</span> (!logFile.isFile() || logFile.length() &lt;= maxLength) {
00145             <span class="keywordflow">return</span>;
00146         }
00147 
00148         <span class="comment">// rename the files to file.1, file.2 and so on</span>
00149         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = maxFiles - 1; i &gt;= 0; i--) {
00150             File from = <span class="keyword">new</span> File(logFile.getAbsolutePath() + (i == 0 ? <span class="stringliteral">""</span> : <span class="stringliteral">"."</span> + i));
00151             File to = <span class="keyword">new</span> File(logFile.getAbsolutePath() + <span class="stringliteral">"."</span> + (i + 1));
00152             <span class="keywordflow">if</span> (from.isFile() &amp;&amp; !to.exists()) {
00153                 from.renameTo(to);
00154             }
00155         }
00156 
00157         <span class="comment">// delete the oldest file</span>
00158         File f = <span class="keyword">new</span> File(logFile.getAbsolutePath() + <span class="stringliteral">"."</span> + maxFiles);
00159         <span class="keywordflow">if</span> (f.isFile()) {
00160             f.delete();
00161         }
00162     }
00163 
<a name="l00170"></a><a class="code" href="classikayaki_1_1_ikayaki.html#h1">00170</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1_ikayaki.html#h1">logDirCleanup</a>(File directory, <span class="keywordtype">int</span> maxDays) {
00171         <span class="keywordflow">if</span> (!directory.isDirectory()) {
00172             <span class="keywordflow">return</span>;
00173         }
00174 
00175         <span class="comment">// get the directory contents and set time limits</span>
00176         File[] files = directory.listFiles();
00177         <span class="keywordtype">long</span> now = System.currentTimeMillis();
00178         <span class="keywordtype">long</span> maxTime = (long) (maxDays) * 24 * 3600 * 1000;
00179 
00180         <span class="comment">// delete all files which are more than maxDays old</span>
00181         <span class="keywordflow">for</span> (File file : files) {
00182             <span class="keywordflow">if</span> (file.isFile() &amp;&amp; (now - file.lastModified()) &gt; maxTime) {
00183                 file.delete();
00184             }
00185         }
00186     }
00187 
<a name="l00194"></a><a class="code" href="classikayaki_1_1_ikayaki.html#a0">00194</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1_ikayaki.html#a0">Ikayaki</a>(<a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="namespaceikayaki_1_1gui.html#a26a1">project</a>) <span class="keywordflow">throws</span> HeadlessException {
00195 
00196         <span class="comment">// set look and feel</span>
00197         PlasticLookAndFeel.setMyCurrentTheme(<span class="keyword">new</span> SkyBlue());
00198         <span class="keywordflow">try</span> {
00199             UIManager.setLookAndFeel(<span class="keyword">new</span> Plastic3DLookAndFeel());
00200         } <span class="keywordflow">catch</span> (UnsupportedLookAndFeelException e) {
00201             System.err.println(e);
00202         }
00203 
00204         <span class="comment">// do layout</span>
00205         <span class="keyword">final</span> <a class="code" href="classikayaki_1_1gui_1_1_main_view_panel.html">MainViewPanel</a> <a class="code" href="classikayaki_1_1_ikayaki.html#e0">main</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1gui_1_1_main_view_panel.html">MainViewPanel</a>(<a class="code" href="namespaceikayaki_1_1gui.html#a26a1">project</a>);
00206         <a class="code" href="classikayaki_1_1_ikayaki.html#a1">setTitle</a>(<a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>);
00207         setIconImage(<span class="keyword">new</span> ImageIcon(ClassLoader.getSystemResource(<span class="stringliteral">"resources/icon.png"</span>)).getImage());
00208         setLayout(<span class="keyword">new</span> BorderLayout());
00209         setJMenuBar(main.<a class="code" href="classikayaki_1_1gui_1_1_main_view_panel.html#a10">getMenuBar</a>());
00210         add(main, <span class="stringliteral">"Center"</span>);
00211         add(main.<a class="code" href="classikayaki_1_1gui_1_1_main_view_panel.html#a11">getStatusBar</a>(), <span class="stringliteral">"South"</span>);
00212 
00213         setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);
00214         pack();
00215 
00216         <span class="comment">// monitor the size of this frame</span>
00217         addComponentListener(<span class="keyword">new</span> ComponentAdapter() {
00218             @Override <span class="keyword">public</span> <span class="keywordtype">void</span> componentResized(ComponentEvent e) {
00219                 <span class="keywordflow">if</span> ((getExtendedState() &amp; MAXIMIZED_BOTH) == 0) {
00220                     <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.setWindowWidth(getWidth());
00221                     <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.setWindowHeight(getHeight());
00222                 }
00223             }
00224         });
00225         addWindowStateListener(<span class="keyword">new</span> WindowStateListener() {
00226             <span class="keyword">public</span> <span class="keywordtype">void</span> windowStateChanged(WindowEvent e) {
00227                 <span class="keywordflow">if</span> ((getExtendedState() &amp; MAXIMIZED_BOTH) != 0) {
00228                     Settings.setWindowMaximized(<span class="keyword">true</span>);
00229                 } <span class="keywordflow">else</span> {
00230                     Settings.setWindowMaximized(<span class="keyword">false</span>);
00231                 }
00232             }
00233         });
00234 
00235         <span class="comment">// set the window close operation</span>
00236         addWindowListener(<span class="keyword">new</span> WindowAdapter() {
00237             @Override <span class="keyword">public</span> <span class="keywordtype">void</span> windowClosing(WindowEvent e) {
00238                 main.exitProgram();
00239             }
00240         });
00241 
00242         <span class="comment">// restore size and position</span>
00243         setSize(Settings.getWindowWidth(), Settings.getWindowHeight());
00244         setLocationByPlatform(<span class="keyword">true</span>);
00245         setVisible(<span class="keyword">true</span>);
00246 
00247         Rectangle maxBounds = GraphicsEnvironment.getLocalGraphicsEnvironment().getMaximumWindowBounds();
00248         setLocation(getX() + getWidth() &gt; maxBounds.width ? maxBounds.width - getWidth() : getX(),
00249                 getY() + getHeight() &gt; maxBounds.height ? maxBounds.height - getHeight() : getY());
00250         setLocation(getX() &lt; 0 ? 0 : getX(), getY() &lt; 0 ? 0 : getY());
00251 
00252         <span class="keywordflow">if</span> (Settings.getWindowMaximized() &amp;&amp; System.getProperty(<span class="stringliteral">"os.name"</span>).startsWith(<span class="stringliteral">"Windows"</span>)) {
00253             <span class="keywordflow">try</span> {
00254                 <span class="comment">// native code for maximizing the window</span>
00255                 <span class="keywordtype">int</span> hwnd = JUtil.getHwnd(getTitle());
00256                 JUtil.setWindowMaximized(hwnd);
00257             } <span class="keywordflow">catch</span> (UnsatisfiedLinkError e) {
00258                 e.printStackTrace();
00259             }
00260         }
00261     }
00262 
<a name="l00268"></a><a class="code" href="classikayaki_1_1_ikayaki.html#a1">00268</a>     @Override <span class="keyword">public</span> <span class="keywordtype">void</span> setTitle(String title) {
00269         <span class="keywordflow">if</span> (title != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00270             super.setTitle(APP_NAME + <span class="stringliteral">" "</span> + APP_VERSION + <span class="stringliteral">" - "</span> + title);
00271         } <span class="keywordflow">else</span> {
00272             super.setTitle(APP_NAME + <span class="stringliteral">" "</span> + APP_VERSION);
00273         }
00274     }
00275 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed May 4 13:11:04 2005 for Squid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
