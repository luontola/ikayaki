<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Squid: My Documents/squid/src/ikayaki/squid/Handler.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">My Documents</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">squid</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">ikayaki</a>&nbsp;/&nbsp;<a class="el" href="dir_000005.html">squid</a></div>
<h1>Handler.java</h1><a href="_handler_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * Handler.java</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright (C) 2005 Project SQUID, http://www.cs.helsinki.fi/group/squid/</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This file is part of Ikayaki.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ikayaki is free software; you can redistribute it and/or modify</span>
00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00011 <span class="comment"> * (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Ikayaki is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> * along with Ikayaki; if not, write to the Free Software</span>
00020 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="keyword">package </span>ikayaki.squid;
00024 
00025 <span class="keyword">import</span> ikayaki.Settings;
00026 <span class="keyword">import</span> ikayaki.util.LastExecutor;
00027 
00028 <span class="keyword">import</span> java.util.concurrent.SynchronousQueue;
00029 <span class="keyword">import</span> java.util.concurrent.TimeUnit;
00030 
<a name="l00036"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html">00036</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1squid_1_1_handler.html">Handler</a> <span class="keyword">implements</span> <a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> {
00037 
<a name="l00041"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r0">00041</a>     <span class="keyword">private</span> SynchronousQueue&lt;String&gt; <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r0">answerQueue</a> = <span class="keyword">new</span> SynchronousQueue&lt;String&gt;();
00042 
<a name="l00047"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r1">00047</a>     <span class="keyword">private</span> <a class="code" href="classikayaki_1_1util_1_1_last_executor.html">LastExecutor</a> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r1">workQueue</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1util_1_1_last_executor.html">LastExecutor</a>(0, <span class="keyword">false</span>);
00048 
<a name="l00052"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r2">00052</a>     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r2">POLL_TIMEOUT</a> = 60;
00053 
<a name="l00057"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">00057</a>     <span class="keyword">protected</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">serialIO</a>;
00058 
<a name="l00062"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r3">00062</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r3">ACCELERATION</a>;
00063 
<a name="l00067"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r4">00067</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r4">DECELERATION</a>;
00068 
<a name="l00076"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r5">00076</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r5">VELOCITY</a>;
00077 
<a name="l00081"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r6">00081</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r6">MEASUREMENT_VELOCITY</a>;
00082 
<a name="l00086"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r7">00086</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r7">SAMPLE_LOAD_POSITION</a>;
00087 
<a name="l00091"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r8">00091</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r8">TRANSVERSE_YAF_POSITION</a>;
00092 
<a name="l00096"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r9">00096</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r9">AXIAL_AF_POSITION</a>;
00097 
<a name="l00101"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r10">00101</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r10">BACKGROUND_POSITION</a>;
00102 
<a name="l00106"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r11">00106</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r11">MEASUREMENT_POSITION</a>;
00107 
<a name="l00111"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r12">00111</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r12">ROTATION_VELOCITY</a>;
00112 
<a name="l00116"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r13">00116</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r13">ROTATION_ACCELERATION</a>;
00117 
<a name="l00121"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r14">00121</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r14">ROTATION_DECELERATION</a>;
00122 
<a name="l00123"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r15">00123</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r15">HANDLER_ROTATION</a>;
00124 
<a name="l00128"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r16">00128</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r16">currentMotor</a> = -1;
00129 
<a name="l00134"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">00134</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> = 0;
00135 
<a name="l00139"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">00139</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a> = 0;
00140 
<a name="l00144"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r19">00144</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r19">currentVelocity</a> = 0;
00145 
<a name="l00149"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">00149</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> = 0;
00150 
<a name="l00154"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r21">00154</a>     <span class="keyword">private</span> <span class="keywordtype">long</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r21">estimatedPositionStartTime</a> = 0;
00155 
<a name="l00156"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">00156</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a> = 0;
00157 
<a name="l00158"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">00158</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> = 0;
<a name="l00159"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r24">00159</a>     <span class="keyword">private</span> <span class="keywordtype">long</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r24">estimatedRotationStartTime</a> = 0;
<a name="l00160"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">00160</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a> = 0;
00161 
<a name="l00165"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#r26">00165</a>     <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r26">waitingForMessage</a> = <span class="keyword">false</span>;
00166 
<a name="l00171"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b0">00171</a>     <span class="keyword">protected</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b0">Handler</a>() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00172         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">serialIO</a> = <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e0">openPort</a>(<span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_parameters.html">SerialParameters</a>(<a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerPort(), 1200, 0, 0, 8, 1, 0));
00173         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">serialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a3">addSerialIOListener</a>(<span class="keyword">this</span>);
00174         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b2">updateSettings</a>();
00175     }
00176 
<a name="l00180"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b1">00180</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b1">setUp</a>() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00181         <span class="comment">// put the system online</span>
00182         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b9">setOnline</a>();
00183 
00184         <span class="comment">// seek the home position, so we can know where we are</span>
00185         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b5">seekHome</a>();
00186     }
00187 
<a name="l00192"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b2">00192</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b2">updateSettings</a>() {
00193         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r3">ACCELERATION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerAcceleration();
00194         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r4">DECELERATION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerDeceleration();
00195         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r9">AXIAL_AF_POSITION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerAxialAFPosition();
00196         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r10">BACKGROUND_POSITION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerBackgroundPosition();
00197         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r7">SAMPLE_LOAD_POSITION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerSampleLoadPosition();
00198         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r11">MEASUREMENT_POSITION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerMeasurementPosition();
00199         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r6">MEASUREMENT_VELOCITY</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerMeasurementVelocity();
00200         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r8">TRANSVERSE_YAF_POSITION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerTransverseYAFPosition();
00201         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r12">ROTATION_VELOCITY</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerRotationVelocity();
00202         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r13">ROTATION_ACCELERATION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerRotationAcceleration();
00203         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r14">ROTATION_DECELERATION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerRotationDeceleration();
00204         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r5">VELOCITY</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerVelocity();
00205         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r15">HANDLER_ROTATION</a> = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getHandlerRotation();
00206     }
00207 
<a name="l00211"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a0">00211</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a0">isMoving</a>() {
00212         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> != <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>;
00213     }
00214 
<a name="l00218"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a1">00218</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a1">isRotating</a>() {
00219         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> != <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a>;
00220     }
00221 
<a name="l00228"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a2">00228</a>     <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a2">getPosition</a>() {
00229         <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a>;
00230     }
00231 
<a name="l00237"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a3">00237</a>     <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a3">getRotation</a>() {
00238         <span class="keywordtype">double</span> angle = (double) (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a>) / <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r15">HANDLER_ROTATION</a> * 360.0;
00239         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) (Math.round(angle)) % 360;
00240     }
00241 
<a name="l00246"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b3">00246</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b3">setPosition</a>(<span class="keywordtype">int</span> position) {
00247         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> == Integer.MAX_VALUE || <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> == Integer.MIN_VALUE) {
00248             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a4">getEstimatedPosition</a>();
00249         } <span class="keywordflow">else</span> {
00250             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a>;
00251         }
00252         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r21">estimatedPositionStartTime</a> = System.currentTimeMillis();
00253         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> = position;
00254         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a>;
00255         System.err.println(<span class="stringliteral">"Start Move:"</span> +
00256                            <span class="stringliteral">" \tstartTime="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r21">estimatedPositionStartTime</a> +
00257                            <span class="stringliteral">" \tstart="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> +
00258                            <span class="stringliteral">" \tend="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>);
00259 
00260     }
00261 
<a name="l00266"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b4">00266</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b4">setRotation</a>(<span class="keywordtype">int</span> rotationSteps) {
00267         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a>;
00268         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r24">estimatedRotationStartTime</a> = System.currentTimeMillis();
00269         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a> = rotationSteps;
00270         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a>;
00271 
00272         <span class="comment">// rotations are always in the same direction, even when rotating back to 0</span>
00273         <span class="keywordflow">while</span> (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a> &lt; <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a>) {
00274             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a> += <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r15">HANDLER_ROTATION</a>;
00275         }
00276         System.err.println(<span class="stringliteral">"Start Rotate:"</span> +
00277                            <span class="stringliteral">" \tstartTime="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r24">estimatedRotationStartTime</a> +
00278                            <span class="stringliteral">" \tstart="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> +
00279                            <span class="stringliteral">" \tend="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a>);
00280 
00281     }
00282 
<a name="l00286"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#d0">00286</a>     <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#d0">fireMovementStopped</a>() {
00287         System.err.println(<span class="stringliteral">"Stop Move:"</span> +
00288                            <span class="stringliteral">" \ttravel Time="</span> + (System.currentTimeMillis()- <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r21">estimatedPositionStartTime</a>) +
00289                            <span class="stringliteral">" \tstart="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> +
00290                            <span class="stringliteral">" \tend="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>);
00291         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> == Integer.MAX_VALUE || <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> == Integer.MIN_VALUE) {
00292             <span class="keywordtype">int</span> pos = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a4">getEstimatedPosition</a>();
00293             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> = pos;
00294             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a> = pos;
00295         } <span class="keywordflow">else</span> {
00296             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a>;
00297             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a>;
00298         }
00299 
00300 
00301     }
00302 
<a name="l00306"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#d1">00306</a>     <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#d1">fireRotationStopped</a>() {
00307         System.err.println(<span class="stringliteral">"Stop Rotate:"</span> +
00308                            <span class="stringliteral">" \ttravel Time="</span> + (System.currentTimeMillis()- <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r24">estimatedRotationStartTime</a>) +
00309                            <span class="stringliteral">" \tstart="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> +
00310                            <span class="stringliteral">" \tend="</span> + <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a>);
00311         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a>;
00312         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a> = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r18">currentRotation</a>;
00313     }
00314 
<a name="l00320"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a4">00320</a>     <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a4">getEstimatedPosition</a>() {
00321 <span class="comment">//        System.err.println("MOVE:" +</span>
00322 <span class="comment">//                "\t  isMoving=" + isMoving() +</span>
00323 <span class="comment">//                " \tstartTime=" + estimatedPositionStartTime +</span>
00324 <span class="comment">//                " \tstart=" + estimatedPositionStart +</span>
00325 <span class="comment">//                " \tend=" + estimatedPositionEnd);</span>
00326         <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1squid_1_1_handler.html#a0">isMoving</a>()) {
00327             <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>;
00328         }
00329 
00330         <span class="comment">// TODO: maybe currentVelocity is not in steps per second?</span>
00331         <span class="keywordtype">double</span> timeSpent = (System.currentTimeMillis() - <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r21">estimatedPositionStartTime</a>) / 1000.0;    <span class="comment">// in seconds</span>
00332         <span class="keywordtype">int</span> pos = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> + (int) (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r19">currentVelocity</a> * timeSpent);
00333 
00334         <span class="comment">/* acceleration correction */</span>
00335         <span class="comment">/*</span>
00336 <span class="comment">        double accTime = (double) currentVelocity / (double) ACCELERATION;</span>
00337 <span class="comment">        if (timeSpent &gt; accTime) {</span>
00338 <span class="comment">            pos -= (1050422 * (accTime * accTime)) / (ACCELERATION);</span>
00339 <span class="comment">        } else {</span>
00340 <span class="comment">            pos = estimatedPositionStart + (int) ((1050422 * (timeSpent * timeSpent)) / (double) (ACCELERATION));</span>
00341 <span class="comment">        }</span>
00342 <span class="comment">*/</span>
00343 
00344         <span class="comment">// we started from PositionStart and if we are already on the other side of PositionEnd, stop at PositionEnd</span>
00345         <span class="keywordflow">if</span> ((<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r20">estimatedPositionStart</a> &lt; <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>) != (pos &lt; <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>)) {
00346             <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r22">estimatedPositionEnd</a>;
00347         } <span class="keywordflow">else</span> {
00348             <span class="keywordflow">return</span> pos;
00349         }
00350     }
00351 
<a name="l00357"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a5">00357</a>     <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a5">getEstimatedRotation</a>() {
00358 <span class="comment">//        System.err.println("ROTATE:" +</span>
00359 <span class="comment">//                "\tisRotating=" + isRotating() +</span>
00360 <span class="comment">//                " \tstartTime=" + estimatedRotationStartTime +</span>
00361 <span class="comment">//                " \tstart=" + estimatedRotationStart +</span>
00362 <span class="comment">//                " \tend=" + estimatedRotationEnd);</span>
00363         <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1squid_1_1_handler.html#a1">isRotating</a>()) {
00364             <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a3">getRotation</a>();
00365         }
00366 
00367         <span class="comment">// TODO: maybe currentVelocity is not in steps per second?</span>
00368         <span class="keywordtype">double</span> timeSpent = (System.currentTimeMillis() - <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r24">estimatedRotationStartTime</a>) / 1000.0;    <span class="comment">// in seconds</span>
00369         <span class="keywordtype">int</span> rotation = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r23">estimatedRotationStart</a> + (int) ((20*<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r19">currentVelocity</a>) * timeSpent);
00370 
00371         <span class="comment">// prevent going over the end limit</span>
00372         <span class="keywordflow">if</span> (rotation &gt; <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a>) {
00373             rotation = <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r25">estimatedRotationEnd</a>;
00374         }
00375 
00376         <span class="keywordtype">double</span> angle = (double) (rotation) / <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r15">HANDLER_ROTATION</a> * 360.0;
00377         <span class="comment">// no need to calculate acceleration, error minimal</span>
00378         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) (Math.round(angle)) % 360;
00379     }
00380 
<a name="l00386"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a6">00386</a>     <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a6">isOK</a>() {
00387         <span class="keywordflow">return</span> (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">serialIO</a> != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>);
00388     }
00389 
<a name="l00394"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b5">00394</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b5">seekHome</a>() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00395 
00396         <span class="comment">// seek home position</span>
00397         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b10">selectMovement</a>();
00398         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r17">currentPosition</a> != Integer.MAX_VALUE) {
00399             <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b8">slewToLimit</a>(<span class="keyword">true</span>);
00400         }
00401 
00402         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b18">setMotorNegative</a>();
00403         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b3">setPosition</a>(0);
00404         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">serialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a0">writeMessage</a>(<span class="stringliteral">"H1,"</span>);
00405         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b20">waitForMessage</a>();
00406         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#d0">fireMovementStopped</a>();
00407 
00408         <span class="comment">// seek home rotation</span>
00409         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b11">selectRotation</a>();
00410         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b17">setMotorPositive</a>();
00411         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b4">setRotation</a>(0);
00412         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#p0">serialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a0">writeMessage</a>(<span class="stringliteral">"H1,"</span>);
00413         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b20">waitForMessage</a>();
00414         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#d1">fireRotationStopped</a>();
00415     }
00416 
<a name="l00421"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a7">00421</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_handler.html#a7">moveToSampleLoad</a>() {
00422         <a class="code" href="classikayaki_1_1squid_1_1_handler.html#r1">workQueue</a>.<a class="code" href="classikayaki_1_1util_1_1_last_executor.html#a8">execute</a>(<span class="keyword">new</span> Runnable() {
00423             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00424                 <span class="keywordflow">try</span> {
00425                     <a class="code" href="classikayaki_1_1squid_1_1_handler.html#b6">moveToPosition</a>(<a class="code" href="classikayaki_1_1squid_1_1_handler.html#r7">SAMPLE_LOAD_POSITION</a>);
00426                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00427                     e.printStackTrace();
00428                 }
00429             }
00430         });
00431     }
00432 
<a name="l00436"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a8">00436</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> moveToDegausserZ() {
00437         workQueue.execute(<span class="keyword">new</span> Runnable() {
00438             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00439                 <span class="keywordflow">try</span> {
00440                     moveToPosition(AXIAL_AF_POSITION);
00441                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00442                     e.printStackTrace();
00443                 }
00444             }
00445         });
00446     }
00447 
<a name="l00452"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a9">00452</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> moveToDegausserY() {
00453         workQueue.execute(<span class="keyword">new</span> Runnable() {
00454             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00455                 <span class="keywordflow">try</span> {
00456                     moveToPosition(TRANSVERSE_YAF_POSITION);
00457                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00458                     e.printStackTrace();
00459                 }
00460             }
00461         });
00462     }
00463 
00464 
<a name="l00468"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a10">00468</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> moveToMeasurement() {
00469         workQueue.execute(<span class="keyword">new</span> Runnable() {
00470             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00471                 <span class="keywordflow">try</span> {
00472                     moveToPosition(MEASUREMENT_POSITION);
00473                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00474                     e.printStackTrace();
00475                 }
00476             }
00477         });
00478     }
00479 
<a name="l00483"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a11">00483</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> moveToBackground() {
00484         workQueue.execute(<span class="keyword">new</span> Runnable() {
00485             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00486                 <span class="keywordflow">try</span> {
00487                     moveToPosition(BACKGROUND_POSITION);
00488                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00489                     e.printStackTrace();
00490                 }
00491             }
00492         });
00493     }
00494 
<a name="l00498"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a12">00498</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> moveToLeftLimit() {
00499         workQueue.execute(<span class="keyword">new</span> Runnable() {
00500             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00501                 <span class="keywordflow">try</span> {
00502                     moveToPosition(Integer.MIN_VALUE);
00503                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00504                     e.printStackTrace();
00505                 }
00506             }
00507         });
00508     }
00509 
<a name="l00513"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a13">00513</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> moveToRightLimit() {
00514         workQueue.execute(<span class="keyword">new</span> Runnable() {
00515             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00516                 <span class="keywordflow">try</span> {
00517                     moveToPosition(Integer.MAX_VALUE);
00518                 } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00519                     e.printStackTrace();
00520                 }
00521             }
00522         });
00523     }
00524 
<a name="l00532"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b6">00532</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> moveToPosition(<span class="keywordtype">int</span> position) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00533         selectMovement();
00534 
00535         <span class="keywordflow">if</span> (position == getPosition()) {
00536             <span class="keywordflow">return</span>;                 <span class="comment">// do not move if we are already there</span>
00537 
00538         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == Integer.MIN_VALUE) {
00539             slewToLimit(<span class="keyword">false</span>);     <span class="comment">// slew to left limit</span>
00540 
00541         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (position == Integer.MAX_VALUE) {
00542             slewToLimit(<span class="keyword">true</span>);      <span class="comment">// slew to right limit</span>
00543 
00544         } <span class="keywordflow">else</span> {
00545 
00546             <span class="comment">// if we are at a limit, we must recalibrate the home position</span>
00547             <span class="keywordflow">if</span> (getPosition() == Integer.MIN_VALUE || getPosition() == Integer.MAX_VALUE) {
00548                 seekHome();
00549             }
00550 
00551             <span class="comment">// obey speed limit and go to the specified position</span>
00552             <span class="keywordflow">if</span> (getPosition() == BACKGROUND_POSITION) {
00553 
00554                 <span class="comment">// currently in background position - speed depends on where we are going</span>
00555                 <span class="comment">// move to the target position and stop there</span>
00556                 <span class="keywordflow">if</span> (position &gt; BACKGROUND_POSITION) {
00557                     moveSteps(position - getPosition(), MEASUREMENT_VELOCITY);
00558                 } <span class="keywordflow">else</span> {
00559                     moveSteps(position - getPosition(), VELOCITY);
00560                 }
00561 
00562             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (getPosition() &lt; BACKGROUND_POSITION) {
00563 
00564                 <span class="comment">// currently in fast speed area</span>
00565                 <span class="keywordflow">if</span> (position &gt; BACKGROUND_POSITION) {
00566                     <span class="comment">// must change the speed at BG position</span>
00567                     moveSteps(BACKGROUND_POSITION - getPosition(), VELOCITY);
00568                     moveToPosition(position);   <span class="comment">// continue movement from BG position</span>
00569                 } <span class="keywordflow">else</span> {
00570                     <span class="comment">// keep the same speed all the way</span>
00571                     moveSteps(position - getPosition(), VELOCITY);
00572                 }
00573 
00574             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (getPosition() &gt; BACKGROUND_POSITION) {
00575 
00576                 <span class="comment">// currently in slow speed area</span>
00577                 <span class="keywordflow">if</span> (position &lt; BACKGROUND_POSITION) {
00578                     <span class="comment">// must change the speed at BG position</span>
00579                     moveSteps(BACKGROUND_POSITION - getPosition(), MEASUREMENT_VELOCITY);
00580                     moveToPosition(position);   <span class="comment">// continue movement from BG position</span>
00581                 } <span class="keywordflow">else</span> {
00582                     <span class="comment">// keep the same speed all the way</span>
00583                     moveSteps(position - getPosition(), MEASUREMENT_VELOCITY);
00584                 }
00585 
00586             } <span class="keywordflow">else</span> {
00587                 assert <span class="keyword">false</span>;
00588             }
00589         }
00590     }
00591 
<a name="l00599"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b7">00599</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> moveSteps(<span class="keywordtype">int</span> steps, <span class="keywordtype">int</span> velocity) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00600         <span class="keywordflow">if</span> (steps &lt; -16777215 || steps &gt; 16777215) {
00601             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"steps = "</span> + steps);
00602         }
00603         selectMovement();
00604         setVelocity(velocity);
00605         <span class="keywordflow">if</span> (steps &gt;= 0) {
00606             setMotorPositive();
00607         } <span class="keywordflow">else</span> {
00608             setMotorNegative();
00609         }
00610 
00611         setPosition(getPosition() + steps);
00612         serialIO.writeMessage(<span class="stringliteral">"N"</span> + Math.abs(steps));
00613         go();
00614 
00615         waitForMessage();
00616         fireMovementStopped();
00617     }
00618 
<a name="l00619"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b8">00619</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> slewToLimit(<span class="keywordtype">boolean</span> toRight) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00620         setVelocity(VELOCITY);
00621         <span class="keywordflow">if</span> (toRight) {
00622             setMotorPositive();
00623             setPosition(Integer.MAX_VALUE);
00624         } <span class="keywordflow">else</span> {
00625             setMotorNegative();
00626             setPosition(Integer.MIN_VALUE);
00627         }
00628         performSlew();
00629         waitForMessage();
00630         fireMovementStopped();
00631     }
00632 
<a name="l00639"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a14">00639</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> rotateTo(<span class="keyword">final</span> <span class="keywordtype">int</span> rotationAngle) {
00640         workQueue.execute(<span class="keyword">new</span> Runnable() {
00641             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00642                 <span class="keywordtype">int</span> angle = rotationAngle % 360;
00643                 <span class="keywordtype">int</span> steps = (<span class="keywordtype">int</span>) (((<span class="keywordtype">double</span>) angle) / 360.0 * HANDLER_ROTATION);
00644 
00645                 <span class="keywordflow">try</span> {
00646                     selectRotation();
00647                     setMotorPositive();
00648 
00649                     <span class="comment">// re-seek home always rotating to zero, otherwise use the counter</span>
00650                     <span class="keywordflow">if</span> (angle == 0) {
00651                         setRotation(0);
00652                         serialIO.writeMessage(<span class="stringliteral">"H1,"</span>);
00653                     } <span class="keywordflow">else</span> {
00654                         <span class="keywordtype">int</span> relativeSteps = steps - currentRotation;
00655                         <span class="keywordflow">while</span> (relativeSteps &lt; 0) {
00656                             relativeSteps += HANDLER_ROTATION;
00657                         }
00658                         relativeSteps = relativeSteps % HANDLER_ROTATION;
00659 
00660                         setRotation(currentRotation + relativeSteps);
00661                         serialIO.writeMessage(<span class="stringliteral">"N"</span> + relativeSteps);
00662                         go();
00663                     }
00664                     waitForMessage();
00665                     fireRotationStopped();
00666 
00667                 } <span class="keywordflow">catch</span> (SerialIOException e) {
00668                     e.printStackTrace();
00669                 }
00670             }
00671         });
00672     }
00673 
<a name="l00680"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a15">00680</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> join() <span class="keywordflow">throws</span> InterruptedException {
00681         workQueue.join();
00682     }
00683 
<a name="l00687"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b9">00687</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> setOnline() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00688         serialIO.writeMessage(<span class="stringliteral">"@0,"</span>);
00689     }
00690 
<a name="l00695"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b10">00695</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> selectMovement() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00696         <span class="keywordflow">if</span> (currentMotor == 0) {
00697             <span class="keywordflow">return</span>;
00698         }
00699         currentMotor = 0;
00700         serialIO.writeMessage(<span class="stringliteral">"O1,0,"</span>);
00701         setVelocity(VELOCITY);
00702         setAcceleration(ACCELERATION);
00703         setDeceleration(DECELERATION);
00704     }
00705 
<a name="l00710"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b11">00710</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> selectRotation() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00711         <span class="keywordflow">if</span> (currentMotor == 1) {
00712             <span class="keywordflow">return</span>;
00713         }
00714         currentMotor = 1;
00715         serialIO.writeMessage(<span class="stringliteral">"O1,1,"</span>);
00716         setVelocity(ROTATION_VELOCITY);
00717         setAcceleration(ROTATION_ACCELERATION);
00718         setDeceleration(ROTATION_DECELERATION);
00719     }
00720 
<a name="l00727"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b12">00727</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> setAcceleration(<span class="keywordtype">int</span> acceleration) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00728         <span class="keywordflow">if</span> (acceleration &lt; 0 || acceleration &gt; 127) {
00729             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"acceleration = "</span> + acceleration);
00730         }
00731         serialIO.writeMessage(<span class="stringliteral">"A"</span> + acceleration + <span class="stringliteral">","</span>);
00732     }
00733 
<a name="l00740"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b13">00740</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> setDeceleration(<span class="keywordtype">int</span> deceleration) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00741         <span class="keywordflow">if</span> (deceleration &lt; 0 || deceleration &gt; 127) {
00742             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"deceleration = "</span> + deceleration);
00743         }
00744         serialIO.writeMessage(<span class="stringliteral">"D"</span> + deceleration + <span class="stringliteral">","</span>);
00745     }
00746 
<a name="l00753"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b14">00753</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> setVelocity(<span class="keywordtype">int</span> velocity) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00754         <span class="keywordflow">if</span> (velocity &lt; 50 || velocity &gt; 8500) {
00755             <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="stringliteral">"velocity = "</span> + velocity);
00756         }
00757         serialIO.writeMessage(<span class="stringliteral">"M"</span> + velocity + <span class="stringliteral">","</span>);
00758         <span class="keywordflow">if</span> (currentVelocity &lt; 0) {
00759             currentVelocity = -velocity;
00760         } <span class="keywordflow">else</span> {
00761             currentVelocity = velocity;
00762         }
00763     }
00764 
<a name="l00769"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b15">00769</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> stopExecution() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00770         serialIO.writeMessage(<span class="stringliteral">"Q,"</span>);
00771     }
00772 
<a name="l00777"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b16">00777</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> performSlew() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00778         selectMovement();
00779         serialIO.writeMessage(<span class="stringliteral">"S,"</span>);
00780     }
00781 
<a name="l00785"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b17">00785</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> setMotorPositive() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00786         serialIO.writeMessage(<span class="stringliteral">"+"</span>);
00787         currentVelocity = Math.abs(currentVelocity);
00788     }
00789 
<a name="l00793"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b18">00793</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> setMotorNegative() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00794         serialIO.writeMessage(<span class="stringliteral">"-"</span>);
00795         currentVelocity = -Math.abs(currentVelocity);
00796     }
00797 
<a name="l00801"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b19">00801</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> go() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00802         serialIO.writeMessage(<span class="stringliteral">"G,"</span>);
00803     }
00804 
<a name="l00813"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b20">00813</a>     <span class="keyword">protected</span> <span class="keywordtype">void</span> waitForMessage() throws <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00814         <span class="comment">// blocks all messages for handler</span>
00815         serialIO.writeMessage(<span class="stringliteral">"F%,"</span>);
00816 
00817         <span class="comment">// just polls for messages, we might get old messages waiting there? Use take message.</span>
00818         <span class="comment">//this.serialIO.writeMessage("%,");</span>
00819         waitingForMessage = <span class="keyword">true</span>;
00820         <span class="keywordflow">try</span> {
00821             answerQueue.take();
00822         } <span class="keywordflow">catch</span> (InterruptedException e) {
00823             e.printStackTrace();
00824         }
00825         waitingForMessage = <span class="keyword">false</span>;
00826     }
00827 
<a name="l00839"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b21">00839</a>     <span class="keyword">protected</span> String verify(<span class="keywordtype">char</span> registry) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00840         serialIO.writeMessage(<span class="stringliteral">"V"</span> + registry + <span class="stringliteral">","</span>);
00841 
00842         waitingForMessage = <span class="keyword">true</span>;
00843         String answer = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00844         <span class="keywordflow">try</span> {
00845             answer = (String) answerQueue.take();
00846         } <span class="keywordflow">catch</span> (InterruptedException e) {
00847             e.printStackTrace();
00848         }
00849         waitingForMessage = <span class="keyword">false</span>;
00850         <span class="keywordflow">return</span> answer;
00851     }
00852 
<a name="l00863"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#b22">00863</a>     <span class="keyword">protected</span> <span class="keywordtype">char</span> takeMessage() <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00864         serialIO.writeMessage(<span class="stringliteral">"%,"</span>);
00865 
00866         waitingForMessage = <span class="keyword">true</span>;
00867         String answer = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00868         <span class="keywordflow">try</span> {
00869             answer = (String) answerQueue.poll(POLL_TIMEOUT, TimeUnit.SECONDS);
00870         } <span class="keywordflow">catch</span> (InterruptedException e) {
00871             e.printStackTrace();
00872         }
00873         waitingForMessage = <span class="keyword">false</span>;
00874         <span class="keywordflow">return</span> answer.charAt(0);
00875     }
00876 
<a name="l00877"></a><a class="code" href="classikayaki_1_1squid_1_1_handler.html#a16">00877</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> serialIOEvent(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_event.html">SerialIOEvent</a> event) {
00878         String message = event.getCleanMessage();
00879         <span class="keywordflow">if</span> (!waitingForMessage) {
00880             System.err.println(<span class="stringliteral">"Recieved a message that nobody waited for: "</span> + message);
00881             <span class="keywordflow">return</span>;
00882         }
00883 
00884         <span class="keywordflow">try</span> {
00885             answerQueue.put(message);
00886         } <span class="keywordflow">catch</span> (InterruptedException e) {
00887             System.err.println(<span class="stringliteral">"Interrupted Handler message event"</span>);
00888             e.printStackTrace();
00889         } <span class="keywordflow">catch</span> (NullPointerException e) {
00890             System.err.println(<span class="stringliteral">"Null from SerialEvent in Handler"</span>);
00891             e.printStackTrace();
00892         }
00893     }
00894 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed May 4 13:11:05 2005 for Squid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
