<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Squid: My Documents/squid/src/ikayaki/squid/SerialIO.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">My Documents</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">squid</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">ikayaki</a>&nbsp;/&nbsp;<a class="el" href="dir_000005.html">squid</a></div>
<h1>SerialIO.java</h1><a href="_serial_i_o_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * SerialIO.java</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright (C) 2005 Project SQUID, http://www.cs.helsinki.fi/group/squid/</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This file is part of Ikayaki.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ikayaki is free software; you can redistribute it and/or modify</span>
00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00011 <span class="comment"> * (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Ikayaki is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> * along with Ikayaki; if not, write to the Free Software</span>
00020 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="keyword">package </span>ikayaki.squid;
00024 
00025 <span class="keyword">import</span> ikayaki.Ikayaki;
00026 
00027 <span class="keyword">import</span> javax.comm.*;
00028 <span class="keyword">import</span> javax.swing.*;
00029 <span class="keyword">import</span> javax.swing.event.EventListenerList;
00030 <span class="keyword">import</span> java.io.*;
00031 <span class="keyword">import</span> java.text.DateFormat;
00032 <span class="keyword">import</span> java.text.SimpleDateFormat;
00033 <span class="keyword">import</span> java.util.Calendar;
00034 <span class="keyword">import</span> java.util.Date;
00035 <span class="keyword">import</span> java.util.TooManyListenersException;
00036 <span class="keyword">import</span> java.util.Vector;
00037 
<a name="l00043"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">00043</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> <span class="keyword">implements</span> SerialPortEventListener {
00044 <span class="comment">/*</span>
00045 <span class="comment">Event A: On new SerialPortEvent - generates new SerialMessageArrivedEvent if a data</span>
00046 <span class="comment">message from serial port is received.</span>
00047 <span class="comment">*/</span>
00048 
<a name="l00049"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v0">00049</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v0">DEBUG</a> = <span class="keyword">true</span>; <span class="comment">// Writes log-file</span>
<a name="l00050"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v1">00050</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateFormat <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v1">dateFormat</a> = <span class="keyword">new</span> SimpleDateFormat(<span class="stringliteral">"HH:mm:ss.SSS"</span>);
00051 
<a name="l00055"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">00055</a>     <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;SerialIO&gt; <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a> = <span class="keyword">new</span> Vector&lt;SerialIO&gt;();
00056 
<a name="l00060"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r0">00060</a>     <span class="keyword">private</span> EventListenerList <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r0">listenerList</a> = <span class="keyword">new</span> EventListenerList();
00061 
<a name="l00065"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r1">00065</a>     <span class="keyword">private</span> SerialPort <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r1">sPort</a>;
00066 
<a name="l00070"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r2">00070</a>     <span class="keyword">private</span> OutputStream <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r2">os</a>;
00071 
<a name="l00075"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r3">00075</a>     <span class="keyword">private</span> InputStream <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r3">is</a>;
00076 
<a name="l00080"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r4">00080</a>     <span class="keyword">private</span> String <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r4">portName</a>;
00081 
<a name="l00085"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r5">00085</a>     <span class="keyword">private</span> BufferedWriter <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r5">logWriter</a>;
00086 
<a name="l00090"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r6">00090</a>     <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r6">logWriterTriedCreate</a> = <span class="keyword">false</span>;
00091 
<a name="l00095"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">00095</a>     <span class="keyword">private</span> <span class="keyword">enum</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">LogEvent</a> {
00096         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1y0">SESSION_START</a>, <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">SEND</a>, <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">REVEIVE</a>
00097     };
00098 
<a name="l00105"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d0">00105</a>     <span class="keyword">private</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d0">SerialIO</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_parameters.html">SerialParameters</a> parameters) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00106         CommPortIdentifier portId;
00107         SerialPort <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r1">sPort</a>;
00108 
00109         <span class="keywordflow">try</span> {
00110             portId = CommPortIdentifier.getPortIdentifier(parameters.getPortName());
00111         } <span class="keywordflow">catch</span> (NoSuchPortException e) {
00112             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"No such port exists:"</span> + parameters.getPortName());
00113         }
00114 
00115         <span class="comment">// Open the port and give it a timeout of 4 seconds</span>
00116         <span class="keywordflow">try</span> {
00117             sPort = (SerialPort) portId.open(<span class="stringliteral">"SerialPort"</span>, 4000);
00118         } <span class="keywordflow">catch</span> (PortInUseException e) {
00119             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"The port "</span> + parameters.getPortName() + <span class="stringliteral">" is already in use"</span>);
00120         }
00121 
00122         <span class="comment">// if debug mode, make own logfile for port</span>
00123         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d2">debug</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">LogEvent</a>.SESSION_START, sPort.getName());
00124 
00125         <span class="comment">// Set the parameters of the connection</span>
00126         <span class="keywordflow">try</span> {
00127             sPort.setSerialPortParams(parameters.getBaudRate(),
00128                     parameters.getDatabits(),
00129                     parameters.getStopbits(),
00130                     parameters.getParity());
00131         } <span class="keywordflow">catch</span> (UnsupportedCommOperationException e) {
00132             sPort.close();
00133             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"Unsupported parameter"</span>);
00134         }
00135 
00136         <span class="comment">// Set flow control</span>
00137         <span class="keywordflow">try</span> {
00138             sPort.setFlowControlMode(parameters.getFlowControlIn()
00139                     | parameters.getFlowControlOut());
00140         } <span class="keywordflow">catch</span> (UnsupportedCommOperationException e) {
00141             sPort.close();
00142             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"Unsupported flow control"</span>);
00143         }
00144 
00145         <span class="comment">// open the streams</span>
00146         <span class="keywordflow">try</span> {
00147             <span class="keyword">this</span>.os = sPort.getOutputStream();
00148             <span class="keyword">this</span>.is = sPort.getInputStream();
00149         } <span class="keywordflow">catch</span> (IOException e) {
00150             sPort.close();
00151             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"Error opening i/o streams"</span>);
00152         }
00153 
00154         <span class="comment">// add this object to be listener for the com port</span>
00155         <span class="keywordflow">try</span> {
00156             sPort.addEventListener(<span class="keyword">this</span>);
00157         } <span class="keywordflow">catch</span> (TooManyListenersException ex) {
00158             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"Too many listeners"</span>);
00159         }
00160 
00161         <span class="comment">// Set notifyOnDataAvailable to true to allow event driven input.</span>
00162         sPort.notifyOnDataAvailable(<span class="keyword">true</span>);
00163 
00164         <span class="comment">// Set notifyOnBreakInterrup to allow event driven break handling. //Unneccessary?</span>
00165         <span class="comment">//sPort.notifyOnBreakInterrupt(true);</span>
00166 
00167         <span class="comment">// Set receive timeout to allow breaking out of polling loop during</span>
00168         <span class="comment">// input handling.</span>
00169         <span class="keywordflow">try</span> {
00170             sPort.enableReceiveTimeout(30);
00171         } <span class="keywordflow">catch</span> (UnsupportedCommOperationException e) {
00172             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"Unsupported operation"</span>);
00173         }
00174 
00175         <span class="keyword">this</span>.sPort = sPort;
00176         <span class="keyword">this</span>.portName = sPort.getName();
00177 
00178         <span class="keywordflow">return</span>;
00179     }
00180 
<a name="l00181"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e0">00181</a>     <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e0">openPort</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_parameters.html">SerialParameters</a> parameters) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00182         <span class="comment">//System.out.println("Let's try to open port: " + parameters.getPortName());  //DEBUG</span>
00183 
00184         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> newPort = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00185 
00186         <span class="comment">// Check if given port is already open</span>
00187         <span class="comment">// if it is then return it instead of creating a new one.</span>
00188         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a>.size(); i++) {
00189             <span class="keywordflow">if</span> (parameters.getPortName().equals(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a>.elementAt(i).portName)) {
00190                 <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a>.elementAt(i);
00191             }
00192         }
00193         newPort = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d0">SerialIO</a>(parameters);
00194         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a>.add(newPort);
00195 
00196         System.out.println(<span class="stringliteral">"Port: "</span> + parameters.getPortName() + <span class="stringliteral">" opened"</span>);
00197         <span class="keywordflow">return</span> newPort;
00198     }
00199 
<a name="l00206"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a0">00206</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a0">writeMessage</a>(String message) <span class="keywordflow">throws</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> {
00207 
00208         byte[] asciiMsg;
00209 
00210         <span class="comment">// convert a message to ASCII</span>
00211         <span class="keywordflow">try</span> {
00212             asciiMsg = message.getBytes(<span class="stringliteral">"US-ASCII"</span>);
00213         } <span class="keywordflow">catch</span> (UnsupportedEncodingException e) {
00214             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"ASCII charset not supported"</span>);
00215         }
00216 
00217         <span class="comment">// send a message to outputstream</span>
00218         <span class="keywordflow">try</span> {
00219             <span class="keywordflow">try</span> {
00220                 Thread.sleep(50); <span class="comment">// Let's wait a bit so we won't flood the system wtih too many messages</span>
00221                 <span class="comment">// 50 msecs seems to work fine with baudrate of 1200..</span>
00222             } <span class="keywordflow">catch</span> (InterruptedException ex) {
00223             }
00224             <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d2">debug</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">LogEvent</a>.SEND, message);
00225             <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r2">os</a>.write(asciiMsg);
00226             <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r2">os</a>.flush(); <span class="comment">// flush the buffer</span>
00227         } <span class="keywordflow">catch</span> (IOException e) {
00228             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a>(<span class="stringliteral">"Couldn't write to outputstream of"</span> + <span class="keyword">this</span>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r4">portName</a>);
00229         }
00230 
00231         <span class="keywordflow">return</span>;
00232     }
00233 
<a name="l00237"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a1">00237</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a1">closePort</a>() {
00238         <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r1">sPort</a> != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00239             <span class="keyword">this</span>.sPort.close();
00240             <span class="keywordflow">try</span> {
00241                 <span class="keyword">this</span>.is.close();
00242             } <span class="keywordflow">catch</span> (IOException ex) {
00243                 System.err.println(<span class="stringliteral">"Could not close inputstream for COM port"</span>);
00244             }
00245             <span class="keywordflow">try</span> {
00246                 <span class="keyword">this</span>.os.close();
00247             } <span class="keywordflow">catch</span> (IOException ex1) {
00248                 System.err.println(<span class="stringliteral">"Could not close outputstream for COM port"</span>);
00249             }
00250         }
00251     }
00252 
<a name="l00256"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e1">00256</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e1">closeAllPorts</a>() {
00257         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a>.size(); i++) {
00258             <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#v2">openPorts</a>.elementAt(i).closePort();
00259         }
00260     }
00261 
<a name="l00265"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a2">00265</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a2">serialEvent</a>(SerialPortEvent event) {
00266         <span class="comment">//System.out.println("New message arrived to port: " + this.portName); //DEBUG</span>
00267         <span class="keywordflow">switch</span> (event.getEventType()) {
00268         <span class="keywordflow">case</span> SerialPortEvent.BI:
00269         <span class="keywordflow">case</span> SerialPortEvent.OE:
00270         <span class="keywordflow">case</span> SerialPortEvent.FE:
00271         <span class="keywordflow">case</span> SerialPortEvent.PE:
00272         <span class="keywordflow">case</span> SerialPortEvent.CD:
00273         <span class="keywordflow">case</span> SerialPortEvent.CTS:
00274         <span class="keywordflow">case</span> SerialPortEvent.DSR:
00275         <span class="keywordflow">case</span> SerialPortEvent.RI:
00276         <span class="keywordflow">case</span> SerialPortEvent.OUTPUT_BUFFER_EMPTY:
00277             <span class="keywordflow">break</span>;
00278         <span class="keywordflow">case</span> SerialPortEvent.DATA_AVAILABLE:
00279             StringBuffer inputBuffer = <span class="keyword">new</span> StringBuffer();
00280             <span class="keywordtype">int</span> newData = 0;
00281             byte[] newByte = <span class="keyword">new</span> byte[1];
00282 
00283             <span class="keywordflow">while</span> (newData != -1) {
00284                 <span class="keywordflow">try</span> {
00285                     newData = <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r3">is</a>.read();
00286                     <span class="keywordflow">if</span> (newData == -1) {
00287                         <span class="keywordflow">break</span>;
00288                     }
00289 <span class="comment">//                    if (false &amp;&amp; '\r' == (char) newData) {</span>
00290 <span class="comment">//                        //inputBuffer.append('\n'); // '\r' chars should be skipped I guess..</span>
00291 <span class="comment">//                    } else {</span>
00292                     newByte[0] = <span class="keyword">new</span> Integer(newData).byteValue();
00293                     inputBuffer.append(<span class="keyword">new</span> String(newByte, <span class="stringliteral">"US-ASCII"</span>));
00294 <span class="comment">//                    }</span>
00295                 } <span class="keywordflow">catch</span> (IOException ex) {
00296                     System.err.println(ex);
00297                     <span class="keywordflow">return</span>;
00298                 }
00299             }
00300 
00301             <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d1">fireSerialIOEvent</a>(<span class="keyword">new</span> String(inputBuffer));
00302 
00303             <span class="comment">//System.out.println("sending: " + new String(inputBuffer)); //debug</span>
00304             <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d2">debug</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#y1">LogEvent</a>.REVEIVE, inputBuffer.toString());
00305 
00306             <span class="keywordflow">break</span>;
00307         }
00308         <span class="keywordflow">return</span>;
00309     }
00310 
<a name="l00316"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a3">00316</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a3">addSerialIOListener</a>(<a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> l) {
00317         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r0">listenerList</a>.add(<a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a>.class, l);
00318     }
00319 
<a name="l00325"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a4">00325</a>     <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a4">removeSerialIOListener</a>(<a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> l) {
00326         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r0">listenerList</a>.remove(<a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a>.class, l);
00327     }
00328 
<a name="l00334"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d1">00334</a>     <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d1">fireSerialIOEvent</a>(String message) {
00335         <span class="keyword">final</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_event.html">SerialIOEvent</a> event = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_event.html">SerialIOEvent</a>(<span class="keyword">this</span>, message);
00336         <span class="keyword">final</span> <a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a>[] listeners = <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#r0">listenerList</a>.getListeners(<a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a>.class);
00337         SwingUtilities.invokeLater(<span class="keyword">new</span> Runnable() {
00338             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00339                 <span class="keywordflow">for</span> (<a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> l : listeners) {
00340                     <span class="keywordflow">try</span> {
00341                         l.serialIOEvent(event);
00342                     } <span class="keywordflow">catch</span> (Throwable t) {
00343                         t.printStackTrace();
00344                     }
00345                 }
00346             }
00347         });
00348     }
00349 
<a name="l00356"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d2">00356</a>     <span class="keyword">private</span> <span class="keywordtype">void</span> debug(LogEvent e, String message) {
00357         <span class="comment">// do nothing if debug mode is off</span>
00358         <span class="keywordflow">if</span> (DEBUG == <span class="keyword">false</span>) <span class="keywordflow">return</span>;
00359 
00360         <span class="comment">// create new log writer if not yet tried</span>
00361         <span class="keywordflow">if</span> (!logWriterTriedCreate) {
00362             logWriterTriedCreate = <span class="keyword">true</span>;
00363 
00364             Calendar now = Calendar.getInstance();
00365             <span class="keywordtype">int</span> y = now.get(Calendar.YEAR), m = now.get(Calendar.MONTH) + 1, d = now.get(Calendar.DAY_OF_MONTH);
00366             String port = e == LogEvent.SESSION_START ? message : portName;
00367             File file = <span class="keyword">new</span> File(<a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.DEBUG_LOG_DIR, y + <span class="stringliteral">"-"</span> + padn(m) + <span class="stringliteral">"-"</span> + padn(d) + <span class="stringliteral">"-"</span> + port + <span class="stringliteral">".log"</span>);
00368 
00369             <span class="keywordtype">boolean</span> oldFile = file.exists();
00370             <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.DEBUG_LOG_DIR.exists()) <a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.DEBUG_LOG_DIR.mkdir();
00371 
00372             <span class="keywordflow">try</span> {
00373                 logWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(file, <span class="keyword">true</span>));
00374                 <span class="comment">// an empty line after previous session</span>
00375                 <span class="keywordflow">if</span> (oldFile) logWriter.newLine();
00376             } <span class="keywordflow">catch</span> (IOException ex1) {
00377                 System.err.println(<span class="stringliteral">"Error creating log file: "</span> + ex1);
00378             }
00379         }
00380 
00381         <span class="comment">// no working log writer :(</span>
00382         <span class="keywordflow">if</span> (logWriter == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span>;
00383 
00384         <span class="comment">// OK, now write the log message...</span>
00385         String time = dateFormat.format(<span class="keyword">new</span> Date());
00386         <span class="keywordflow">try</span> {
00387             logWriter.write(time + <span class="stringliteral">" "</span> + e + <span class="stringliteral">": "</span> + message);
00388             logWriter.newLine();
00389             logWriter.flush();
00390         } <span class="keywordflow">catch</span> (IOException ex1) {
00391             System.err.println(ex1);
00392         }
00393     }
00394 
<a name="l00401"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#d3">00401</a>     <span class="keyword">private</span> String padn(<span class="keywordtype">int</span> n) {
00402         <span class="keywordflow">return</span> (n &lt; 10 ? <span class="stringliteral">"0"</span> : <span class="stringliteral">""</span>) + n;
00403     }
00404 
<a name="l00405"></a><a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a5">00405</a>     <span class="keyword">public</span> String getPortName() {
00406         <span class="keywordflow">return</span> portName;
00407     }
00408 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed May 4 13:11:05 2005 for Squid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
