<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Squid: My Documents/squid/src/ikayaki/squid/SquidEmulator.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">My Documents</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">squid</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">ikayaki</a>&nbsp;/&nbsp;<a class="el" href="dir_000005.html">squid</a></div>
<h1>SquidEmulator.java</h1><a href="_squid_emulator_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * SquidEmulator.java</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright (C) 2005 Project SQUID, http://www.cs.helsinki.fi/group/squid/</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This file is part of Ikayaki.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ikayaki is free software; you can redistribute it and/or modify</span>
00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00011 <span class="comment"> * (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Ikayaki is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> * along with Ikayaki; if not, write to the Free Software</span>
00020 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="keyword">package </span>ikayaki.squid;
00024 
00025 <span class="keyword">import</span> java.io.File;
00026 <span class="keyword">import</span> java.io.FileWriter;
00027 <span class="keyword">import</span> java.io.IOException;
00028 <span class="keyword">import</span> java.util.Stack;
00029 
<a name="l00041"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html">00041</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html">SquidEmulator</a> {
<a name="l00042"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#a0">00042</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#a0">SquidEmulator</a>() {
00043         <span class="keywordflow">try</span> {
00044             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#d0">jbInit</a>();
00045         } <span class="keywordflow">catch</span> (Exception ex) {
00046             ex.printStackTrace();
00047         }
00048     }
00049 
00050     <span class="comment">/*</span>
00051 <span class="comment">    Event A: On New IO Message - reads message and puts it in Buffer</span>
00052 <span class="comment">    */</span>
00053 
<a name="l00057"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v0">00057</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v0">online</a>;
00058 
<a name="l00062"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v1">00062</a>     <span class="keyword">private</span> <span class="keyword">static</span> File <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v1">logFile</a>;
00063 
<a name="l00067"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v2">00067</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v2">usingOldLog</a>;
00068 
<a name="l00072"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v3">00072</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v3">acceleration</a>;
00073 
<a name="l00077"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v4">00077</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v4">deceleration</a>;
00078 
<a name="l00086"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v5">00086</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v5">velocity</a>;
00087 
<a name="l00091"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v6">00091</a>     <span class="keyword">private</span> <span class="keyword">static</span> String <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v6">handlerStatus</a>;
00092 
<a name="l00096"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v7">00096</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v7">commandedDistance</a>;
00097 
<a name="l00101"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v8">00101</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v8">currentPosition</a>;
00102 
<a name="l00106"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v9">00106</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v9">homePosition</a>;
00107 
<a name="l00111"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v10">00111</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v10">commandedRotation</a>;
00112 
<a name="l00116"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v11">00116</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v11">currentRotation</a>;
00117 
<a name="l00121"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v12">00121</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v12">degausserCoil</a>;
00122 
<a name="l00126"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v13">00126</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v13">degausserAmplitude</a>;
00127 
<a name="l00131"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v14">00131</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v14">degausserDelay</a>;
00132 
<a name="l00136"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v15">00136</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v15">degausserRamp</a>;
00137 
<a name="l00141"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v16">00141</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v16">degausserStatus</a>;
00142 
<a name="l00147"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v17">00147</a>     <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v17">handlerPort</a>;
<a name="l00148"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">00148</a>     <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a>;
<a name="l00149"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v19">00149</a>     <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v19">degausserPort</a>;
00150 
<a name="l00151"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">00151</a>     <span class="keyword">private</span> <span class="keyword">static</span> FileWriter <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a> = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00152 
<a name="l00153"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v21">00153</a>     <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html">HandlerEmu</a> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v21">handler</a>;
<a name="l00154"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v22">00154</a>     <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html">MagnetometerEmu</a> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v22">magnetometer</a>;
<a name="l00155"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v23">00155</a>     <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html">DegausserEmu</a> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v23">degausser</a>;
<a name="l00156"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">00156</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">running</a>;
00157 
<a name="l00164"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">00164</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(String message, <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a> port) {
00165         <span class="comment">//writes log if indicated to do so</span>
00166         <span class="keywordflow">try</span> {
00167             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.write(<span class="stringliteral">"SEND:"</span> + message + <span class="stringliteral">"\n"</span>);
00168             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.flush();
00169         } <span class="keywordflow">catch</span> (IOException e) {
00170             System.err.println(<span class="stringliteral">"Error on writing log file"</span>);
00171         }
00172         <span class="keywordflow">try</span> {
00173             port.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a0">writeMessage</a>(message);
00174         } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> ex) {
00175             System.err.println(ex);
00176         }
00177         <span class="keywordflow">return</span>;
00178     }
00179 
<a name="l00184"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e1">00184</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e1">main</a>(String[] args) {
00185         System.out.println(<span class="stringliteral">"Starting..."</span>);
00186         <span class="keywordflow">try</span> {
00187             <span class="keywordtype">int</span> samePort = Integer.parseInt(args[0]);
00188             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v17">handlerPort</a> = <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e0">openPort</a>(<span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_parameters.html">SerialParameters</a>(args[1]));
00189             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a> = <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e0">openPort</a>(<span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_parameters.html">SerialParameters</a>(args[2]));
00190             <span class="keywordflow">if</span> (samePort == 0) {
00191                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v19">degausserPort</a> = <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#e0">openPort</a>(<span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_serial_parameters.html">SerialParameters</a>(args[3]));
00192             } <span class="keywordflow">else</span> {
00193                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v19">degausserPort</a> = <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a>;
00194             }
00195             <span class="keywordflow">if</span> (samePort == 0) {
00196                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v1">logFile</a> = <span class="keyword">new</span> File(args[4]);
00197             } <span class="keywordflow">else</span> {
00198                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v1">logFile</a> = <span class="keyword">new</span> File(args[5]);
00199             }
00200             <span class="comment">//Only writing, TODO:switch to reading option</span>
00201             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a> = <span class="keyword">new</span> FileWriter(<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v1">logFile</a>);
00202         } <span class="keywordflow">catch</span> (<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_exception.html">SerialIOException</a> e) {
00203             System.out.println(e);
00204             <span class="keywordflow">return</span>;
00205         } <span class="keywordflow">catch</span> (Exception e) {
00206             System.out.println(
00207                     <span class="stringliteral">"Usage \"java SquidEmulator (0:Magnetometer and Degausser use different ports, 1: Magnetometer and Degausser use same port) HandlerPort MagnetometerPort (optional)DegausserPort Log_filename\""</span>);
00208             <span class="keywordflow">return</span>;
00209         }
00210 
00211         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">running</a> = <span class="keyword">true</span>;
00212 
00213         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v21">handler</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html">HandlerEmu</a>();
00214         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v21">handler</a>.start();
00215         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v22">magnetometer</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html">MagnetometerEmu</a>();
00216         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v22">magnetometer</a>.start();
00217         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v23">degausser</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html">DegausserEmu</a>();
00218         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v23">degausser</a>.start();
00219 
00220         System.out.println(<span class="stringliteral">"System running..."</span>);
00221         <span class="keywordflow">try</span> {
00222             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.write(<span class="stringliteral">"SESSION STARTED:\n"</span>);
00223             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.flush();
00224         } <span class="keywordflow">catch</span> (IOException ex1) {
00225             System.out.println(<span class="stringliteral">"Writing error"</span>);
00226         }
00227 
00228         <span class="keywordflow">try</span> {
00229             <span class="comment">//wait for signal to quit 8)</span>
00230             System.in.read();
00231         } <span class="keywordflow">catch</span> (IOException ex) {
00232         }
00233 
00234         <a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html">SerialIO</a>.closeAllPorts();
00235         <span class="keywordflow">try</span> {
00236             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.close();
00237         } <span class="keywordflow">catch</span> (IOException ex2) {
00238         }
00239 
00240         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">running</a> = <span class="keyword">false</span>;
00241 
00242         <span class="keywordflow">return</span>;
00243     }
00244 
<a name="l00245"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#d0">00245</a>     <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#d0">jbInit</a>() <span class="keywordflow">throws</span> Exception {
00246     }
00247 
<a name="l00252"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html">00252</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html">HandlerEmu</a> <span class="keyword">extends</span> Thread implements <a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> {
00253 
00254 
00255         <span class="comment">//All recieved commands</span>
<a name="l00256"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r0">00256</a>         <span class="keyword">private</span> Stack&lt;String&gt; <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r0">commandStack</a>;
00257 
00258         <span class="comment">//remainder of last command (commands are separated with ',')</span>
<a name="l00259"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r1">00259</a>         <span class="keyword">private</span> String <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r1">lastMessagePart</a> = <span class="stringliteral">""</span>;
00260 
<a name="l00261"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#a0">00261</a>         <span class="keyword">public</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#a0">HandlerEmu</a>() {
00262             <span class="comment">//Setlistener to handlePort</span>
00263             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v17">handlerPort</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a3">addSerialIOListener</a>(<span class="keyword">this</span>);
00264             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r0">commandStack</a> = <span class="keyword">new</span> Stack&lt;String&gt;();
00265         }
00266 
<a name="l00267"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#a1">00267</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#a1">run</a>() {
00268             <span class="keywordflow">while</span> (<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">running</a>) {
00269 
00270                 <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r0">commandStack</a>.empty()) {
00271                     String command = <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r0">commandStack</a>.pop();
00272                     <span class="keywordflow">if</span> (command.startsWith(<span class="stringliteral">"V"</span>, 0)) {
00273                         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(<span class="stringliteral">"100"</span> + command, <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v17">handlerPort</a>);
00274                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (command.startsWith(<span class="stringliteral">"F"</span>, 0) || command.startsWith(<span class="stringliteral">"%"</span>, 0)) {
00275                         <span class="keywordflow">try</span> {
00276                             Thread.sleep(2000);
00277                         } <span class="keywordflow">catch</span> (InterruptedException ex1) {
00278                         }
00279                         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(<span class="stringliteral">"perillä"</span> + command, <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v17">handlerPort</a>);
00280                     }
00281                 }
00282                 <span class="keywordflow">try</span> {
00283                     Thread.sleep(100);
00284                 } <span class="keywordflow">catch</span> (InterruptedException ex) {
00285                 }
00286             }
00287         }
00288 
<a name="l00289"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#a2">00289</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#a2">serialIOEvent</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_event.html">SerialIOEvent</a> event) {
00290             <span class="keywordtype">int</span> i;
00291             <span class="keywordflow">try</span> {
00292                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.write(<span class="stringliteral">"HANDLER_RECIEVE:"</span> + event.getCleanMessage() + <span class="stringliteral">"\n"</span>);
00293                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.flush();
00294             } <span class="keywordflow">catch</span> (IOException ex) {
00295             }
00296             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_handler_emu.html#r0">commandStack</a>.add(event.getCleanMessage());
00297             <span class="comment">/*</span>
00298 <span class="comment">            String message = lastMessagePart + event.getCleanMessage();</span>
00299 <span class="comment">            String[] commands = message.split(",");</span>
00300 <span class="comment">            for (i = 0; i &lt; commands.length - 1; i++) {</span>
00301 <span class="comment">                commandStack.add(commands[i]);</span>
00302 <span class="comment">            }</span>
00303 <span class="comment">            if(commands.length == 1)</span>
00304 <span class="comment">              commandStack.add(commands[0]);</span>
00305 <span class="comment">            else if(commands.length &gt;= i &amp;&amp; commands[i] != null)</span>
00306 <span class="comment">              lastMessagePart = commands[i];</span>
00307 <span class="comment">             */</span>
00308         }
00309     }
00310 
<a name="l00315"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html">00315</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html">MagnetometerEmu</a> <span class="keyword">extends</span> Thread implements <a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> {
00316         <span class="comment">//All recieved commands</span>
<a name="l00317"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#r0">00317</a>         <span class="keyword">private</span> Stack&lt;String&gt; <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#r0">commandStack</a>;
00318 
<a name="l00319"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#a0">00319</a>         <span class="keyword">public</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#a0">MagnetometerEmu</a>() {
00320             <span class="comment">//Setlistener to port</span>
00321             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a3">addSerialIOListener</a>(<span class="keyword">this</span>);
00322             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#r0">commandStack</a> = <span class="keyword">new</span> Stack&lt;String&gt;();
00323         }
00324 
00325 
<a name="l00326"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#a1">00326</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#a1">run</a>() {
00327             <span class="keywordflow">while</span> (<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">running</a>) {
00328 
00329                 <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#r0">commandStack</a>.empty()) {
00330                     String command = <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#r0">commandStack</a>.pop();
00331                     <span class="keywordflow">if</span> (command.startsWith(<span class="stringliteral">"SD"</span>, 1)) {
00332                         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(<span class="stringliteral">"+"</span> + Math.random(), <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a>);
00333                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (command.startsWith(<span class="stringliteral">"SC"</span>, 1)) {
00334                         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(<span class="stringliteral">"+"</span> + (<span class="keywordtype">int</span>) (Math.random() * 100), <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a>);
00335                     } <span class="keywordflow">else</span> {
00336                         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(<span class="stringliteral">"1"</span>, <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v18">magnetometerPort</a>);
00337                     }
00338                     <span class="comment">/*</span>
00339 <span class="comment">                    else if(command.startsWith("Y",0)) {</span>
00340 <span class="comment">                      writeMessage("+" + Math.random(), magnetometerPort);</span>
00341 <span class="comment">                    }</span>
00342 <span class="comment">                    else if(command.startsWith("Z",0)) {</span>
00343 <span class="comment">                      writeMessage("+" + Math.random(), magnetometerPort);</span>
00344 <span class="comment">                    }</span>
00345 <span class="comment">      */</span>
00346                 }
00347                 <span class="keywordflow">try</span> {
00348                     Thread.sleep(100);
00349                 } <span class="keywordflow">catch</span> (InterruptedException ex) {
00350                 }
00351             }
00352 
00353         }
00354 
<a name="l00355"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#a2">00355</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#a2">serialIOEvent</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_event.html">SerialIOEvent</a> event) {
00356             <span class="keywordflow">try</span> {
00357                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.write(<span class="stringliteral">"MAGNETOMETER_RECIEVE:"</span> + event.getCleanMessage() + <span class="stringliteral">"\n"</span>);
00358                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.flush();
00359             } <span class="keywordflow">catch</span> (IOException ex) {
00360             }
00361 
00362             String message = event.getCleanMessage();
00363             String[] commands = message.split(<span class="stringliteral">"/r"</span>);
00364             <span class="comment">//we only accept first "part". And only if it starts with A,X,Y,Z</span>
00365             <span class="keywordflow">if</span> (commands[0].charAt(0) == <span class="charliteral">'A'</span> || commands[0].charAt(0) == <span class="charliteral">'X'</span> || commands[0].charAt(0) == <span class="charliteral">'Y'</span> || commands[0].charAt(
00366                     0) == <span class="charliteral">'Z'</span>) {
00367                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_magnetometer_emu.html#r0">commandStack</a>.add(commands[0]);
00368             }
00369         }
00370     }
00371 
<a name="l00376"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html">00376</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html">DegausserEmu</a>
00377             <span class="keyword">extends</span> Thread implements <a class="code" href="interfaceikayaki_1_1squid_1_1_serial_i_o_listener.html">SerialIOListener</a> {
00378 
00379         <span class="comment">//All recieved commands</span>
<a name="l00380"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#r0">00380</a>         <span class="keyword">private</span> Stack&lt;String&gt; <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#r0">commandStack</a>;
00381 
<a name="l00382"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#a0">00382</a>         <span class="keyword">public</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#a0">DegausserEmu</a>() {
00383             <span class="comment">//Setlistener to port</span>
00384             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v19">degausserPort</a>.<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o.html#a3">addSerialIOListener</a>(<span class="keyword">this</span>);
00385             <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#r0">commandStack</a> = <span class="keyword">new</span> Stack&lt;String&gt;();
00386         }
00387 
00388 
<a name="l00389"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#a1">00389</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#a1">run</a>() {
00390             <span class="keywordflow">while</span> (<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v24">running</a>) {
00391 
00392                 <span class="keywordflow">if</span> (!<a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#r0">commandStack</a>.empty()) {
00393                     String command = <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#r0">commandStack</a>.pop();
00394                     <span class="keywordflow">if</span> (command.startsWith(<span class="stringliteral">"D"</span>, 0)) {
00395                         <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#e0">writeMessage</a>(<span class="stringliteral">"DONE"</span>, <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v19">degausserPort</a>);
00396                     }
00397                 }
00398                 <span class="keywordflow">try</span> {
00399                     Thread.sleep(100);
00400                 } <span class="keywordflow">catch</span> (InterruptedException ex) {
00401                 }
00402             }
00403 
00404         }
00405 
<a name="l00406"></a><a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#a2">00406</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#a2">serialIOEvent</a>(<a class="code" href="classikayaki_1_1squid_1_1_serial_i_o_event.html">SerialIOEvent</a> event) {
00407             <span class="keywordflow">try</span> {
00408                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.write(<span class="stringliteral">"DEGAUSSER_RECIEVE:"</span> + event.getCleanMessage() + <span class="stringliteral">"\n"</span>);
00409                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator.html#v20">logWriter</a>.flush();
00410             } <span class="keywordflow">catch</span> (IOException ex) {
00411             }
00412 
00413             String message = event.getCleanMessage();
00414             String[] commands = message.split(<span class="stringliteral">"/r"</span>);
00415             <span class="comment">//we only accept first "part". And only if it starts with D</span>
00416             <span class="keywordflow">if</span> (commands[0].charAt(0) == <span class="charliteral">'D'</span>) {
00417                 <a class="code" href="classikayaki_1_1squid_1_1_squid_emulator_1_1_degausser_emu.html#r0">commandStack</a>.add(commands[0]);
00418             }
00419         }
00420     }
00421 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed May 4 13:11:05 2005 for Squid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
