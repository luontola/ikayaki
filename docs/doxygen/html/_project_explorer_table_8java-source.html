<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Squid: My Documents/squid/src/ikayaki/gui/ProjectExplorerTable.java Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Packages</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">My Documents</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">squid</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">ikayaki</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">gui</a></div>
<h1>ProjectExplorerTable.java</h1><a href="_project_explorer_table_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> * ProjectExplorerTable.java</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * Copyright (C) 2005 Project SQUID, http://www.cs.helsinki.fi/group/squid/</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This file is part of Ikayaki.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * Ikayaki is free software; you can redistribute it and/or modify</span>
00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00011 <span class="comment"> * (at your option) any later version.</span>
00012 <span class="comment"> *</span>
00013 <span class="comment"> * Ikayaki is distributed in the hope that it will be useful,</span>
00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
00016 <span class="comment"> * GNU General Public License for more details.</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00019 <span class="comment"> * along with Ikayaki; if not, write to the Free Software</span>
00020 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
00021 <span class="comment"> */</span>
00022 
00023 <span class="keyword">package </span>ikayaki.gui;
00024 
00025 <span class="keyword">import</span> ikayaki.*;
00026 
00027 <span class="keyword">import</span> javax.swing.*;
00028 <span class="keyword">import</span> javax.swing.border.Border;
00029 <span class="keyword">import</span> javax.swing.event.ListSelectionEvent;
00030 <span class="keyword">import</span> javax.swing.event.ListSelectionListener;
00031 <span class="keyword">import</span> javax.swing.table.AbstractTableModel;
00032 <span class="keyword">import</span> javax.swing.table.TableColumn;
00033 <span class="keyword">import</span> javax.swing.table.TableColumnModel;
00034 <span class="keyword">import</span> java.awt.*;
00035 <span class="keyword">import</span> java.awt.event.ActionEvent;
00036 <span class="keyword">import</span> java.awt.event.ActionListener;
00037 <span class="keyword">import</span> java.awt.event.MouseAdapter;
00038 <span class="keyword">import</span> java.awt.event.MouseEvent;
00039 <span class="keyword">import</span> java.io.File;
00040 <span class="keyword">import</span> java.io.FileFilter;
00041 <span class="keyword">import</span> java.text.DateFormat;
00042 <span class="keyword">import</span> java.util.Arrays;
00043 <span class="keyword">import</span> java.util.Comparator;
00044 <span class="keyword">import</span> java.util.Date;
00045 
<a name="l00051"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">00051</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">ProjectExplorerTable</a> <span class="keyword">extends</span> JTable implements <a class="code" href="interfaceikayaki_1_1_project_listener.html">ProjectListener</a> {
00052 
<a name="l00056"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r0">00056</a>     <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classikayaki_1_1gui_1_1_project_component.html">ProjectComponent</a> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r0">parent</a>;
00057 
<a name="l00061"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r1">00061</a>     <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r1">isCalibration</a>;
00062 
<a name="l00063"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r2">00063</a>     <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html">ProjectExplorerTableModel</a> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r2">explorerTableModel</a>;
00064 
<a name="l00065"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r3">00065</a>     <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;File&gt; <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r3">explorerTableComparator</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_comparator.html">ProjectExplorerTableComparator</a>();
00066 
<a name="l00071"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r4">00071</a>     <span class="keyword">private</span> Thread <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r4">projectTypeCacher</a> = <span class="keyword">new</span> Thread();
00072 
<a name="l00076"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r5">00076</a>     <span class="keyword">private</span> File <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r5">directory</a>;
00077 
<a name="l00081"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r6">00081</a>     <span class="keyword">private</span> File[] <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r6">files</a> = <span class="keyword">new</span> File[0];
00082 
<a name="l00086"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r7">00086</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r7">selectedFile</a> = -1;
00087 
<a name="l00091"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r8">00091</a>     <span class="keyword">private</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r8">explorerTableSortColumn</a> = 0;
00092 
00093     <span class="comment">// possible columns and their names</span>
<a name="l00094"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#v0">00094</a>     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#v0">COLUMN_UNDEFINED</a> = -1;
<a name="l00095"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s0">00095</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s0">COLUMN_FILENAME</a> = 0;
<a name="l00096"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s1">00096</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s1">COLUMN_TYPE</a> = 1;
<a name="l00097"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s2">00097</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s2">COLUMN_LASTMOD</a> = 2;
<a name="l00098"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s3">00098</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s3">COLUMN_LASTMEASURE</a> = 3;
<a name="l00099"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s4">00099</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s4">COLUMN_UNMEASURED</a> = 4;
<a name="l00100"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s5">00100</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s5">column_name</a> = {<span class="stringliteral">"Name"</span>, <span class="stringliteral">"Type"</span>, <span class="stringliteral">"Modified"</span>, <span class="stringliteral">"Measured"</span>, <span class="stringliteral">"Elapsed"</span>};
00101 
00102     <span class="comment">// default column configurations for different table types</span>
<a name="l00103"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s6">00103</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span>[] <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s6">default_columns</a> = {<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s0">COLUMN_FILENAME</a>, <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s1">COLUMN_TYPE</a>, <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s2">COLUMN_LASTMOD</a>};
<a name="l00104"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s7">00104</a>     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span>[] <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s7">calibration_columns</a> = {<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s0">COLUMN_FILENAME</a>, <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s3">COLUMN_LASTMEASURE</a>, <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s4">COLUMN_UNMEASURED</a>};
00105 
<a name="l00110"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r9">00110</a>     <span class="keyword">private</span> <span class="keywordtype">int</span>[] <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r9">columns</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[0];
00111 
<a name="l00117"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a0">00117</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a0">ProjectExplorerTable</a>(<a class="code" href="classikayaki_1_1gui_1_1_project_component.html">ProjectComponent</a> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r0">parent</a>) {
00118         <span class="keyword">this</span>(parent, <span class="keyword">false</span>);
00119     }
00120 
<a name="l00127"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a1">00127</a>     <span class="keyword">public</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a0">ProjectExplorerTable</a>(<a class="code" href="classikayaki_1_1gui_1_1_project_component.html">ProjectComponent</a> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r0">parent</a>, <span class="keywordtype">boolean</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r1">isCalibration</a>) {
00128         <span class="keyword">this</span>.parent = parent;
00129         <span class="keyword">this</span>.isCalibration = isCalibration;
00130 
00131         <span class="comment">// create TableModel only after columns are set</span>
00132         <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r2">explorerTableModel</a> = <span class="keyword">new</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html">ProjectExplorerTableModel</a>();
00133         <span class="keyword">this</span>.setModel(<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r2">explorerTableModel</a>);
00134 
00135         <span class="comment">// allow multiple line selection for multi-file-export</span>
00136         <span class="comment">// this.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
00137         <span class="keyword">this</span>.getTableHeader().setReorderingAllowed(<span class="keyword">false</span>);
00138         <span class="keyword">this</span>.getTableHeader().setResizingAllowed(<span class="keyword">false</span>);
00139         <span class="keyword">this</span>.setShowGrid(<span class="keyword">false</span>);
00140         <span class="keyword">this</span>.setIntercellSpacing(<span class="keyword">new</span> Dimension(0, 0));
00141         <span class="keyword">this</span>.setDefaultRenderer(<a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html">StyledWrapper</a>.class, <span class="keyword">new</span> <a class="code" href="classikayaki_1_1gui_1_1_styled_table_cell_renderer.html">StyledTableCellRenderer</a>());
00142 
00143         <span class="comment">// TODO: what should be here anyway?</span>
00144         <span class="comment">// this.setPreferredScrollableViewportSize(new Dimension(280, 400));</span>
00145 
00146         <span class="comment">// set the right visible columns for table type</span>
00147         <span class="keywordflow">if</span> (<span class="keyword">this</span>.isCalibration) {
00148             <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a2">setColumns</a>(<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s7">calibration_columns</a>);
00149         } <span class="keywordflow">else</span> {
00150             <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a2">setColumns</a>(<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#s6">default_columns</a>);
00151         }
00152 
00153         <span class="comment">// ProjectExplorerTable events</span>
00154 
00160         <span class="keyword">this</span>.getSelectionModel().addListSelectionListener(<span class="keyword">new</span> ListSelectionListener() {
00161             <span class="keyword">public</span> <span class="keywordtype">void</span> valueChanged(ListSelectionEvent e) {
00162 
00163                 <span class="comment">/* TODO:</span>
00164 <span class="comment">                 * It is possible by CTRL-clicking to deselect the selected row. This can cause problems</span>
00165 <span class="comment">                 * because after that the user will not anymore see which of the files is open. Change it</span>
00166 <span class="comment">                 * so that if for some reason no row is selected and the currently open project is in this</span>
00167 <span class="comment">                 * directory, select that project's file.</span>
00168 <span class="comment">                 */</span>
00169                 <span class="comment">// - done, see below</span>
00170 
00171                 <span class="comment">// we only want the actually selected row, and don't want to react to an already selected line</span>
00172                 <span class="comment">// (which could also mean that we had a load error, and that selection was reverted)</span>
00173                 <span class="keywordflow">if</span> (e.getValueIsAdjusting() || getSelectedRow() == <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r7">selectedFile</a>) <span class="keywordflow">return</span>;
00174                 <span class="keywordflow">if</span> (getSelectedRowCount() &gt; 1) <span class="keywordflow">return</span>; <span class="comment">// do nothing if multiple files selected</span>
00175 
00176                 <a class="code" href="classikayaki_1_1_project.html">Project</a> <a class="code" href="namespaceikayaki_1_1gui.html#a26a1">project</a> = getSelectedRow() == -1 ? <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> : <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r6">files</a>[getSelectedRow()]);
00177 
00178                 <span class="comment">// if load error, or nothing selected, revert back to old selection</span>
00179                 <span class="keywordflow">if</span> (project == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00180                     <span class="comment">// TODO: flash selected row red for 100 ms, perhaps? - might require a custom cell renderer</span>
00181                     <span class="keywordflow">if</span> (<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r7">selectedFile</a> == -1) {
00182                         clearSelection();
00183                     } <span class="keywordflow">else</span> {
00184                         setRowSelectionInterval(<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r7">selectedFile</a>, <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#r7">selectedFile</a>);
00185                     }
00186                 } <span class="keywordflow">else</span> {
00187                     <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">ProjectExplorerTable</a>.this.parent.setProject(project);
00188                 }
00189             }
00190         });
00191 
00196         <span class="keyword">this</span>.addMouseListener(<span class="keyword">new</span> MouseAdapter() {
00197             <span class="keyword">public</span> <span class="keywordtype">void</span> mouseClicked(MouseEvent e) {
00198                 <span class="comment">// only right-click brings popup menu</span>
00199                 <span class="keywordflow">if</span> (e.getButton() != MouseEvent.BUTTON3) <span class="keywordflow">return</span>;
00200 
00201                 <span class="keywordtype">int</span>[] row;
00202                 <span class="keywordflow">if</span> (getSelectedRowCount() &gt; 1) {
00203                     row = getSelectedRows();
00204                 } <span class="keywordflow">else</span> {
00205                     row = <span class="keyword">new</span> <span class="keywordtype">int</span>[]{rowAtPoint(e.getPoint())};
00206                 }
00207 
00208                 <span class="comment">// copy files matching selected (or clicked) rows</span>
00209                 File[] file = <span class="keyword">new</span> File[row.length];
00210                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; row.length; n++) file[n] = files[row[n]];
00211 
00212                 <span class="comment">// construct a new popup menu for every click</span>
00213                 ProjectExplorerPopupMenu explorerTablePopup = <span class="keyword">new</span> ProjectExplorerPopupMenu(file);
00214                 explorerTablePopup.show(ProjectExplorerTable.this, e.getX(), e.getY());
00215             }
00216         });
00217 
00221         <span class="keyword">this</span>.getTableHeader().addMouseListener(<span class="keyword">new</span> MouseAdapter() {
00222             <span class="keyword">public</span> <span class="keywordtype">void</span> mouseClicked(MouseEvent e) {
00223                 <span class="comment">// only left-click changes sorting</span>
00224                 <span class="keywordflow">if</span> (e.getButton() != MouseEvent.BUTTON1) <span class="keywordflow">return</span>;
00225 
00226                 TableColumnModel cm = getColumnModel();
00227                 <span class="keywordtype">int</span> viewColumn = cm.getColumnIndexAtX(e.getX());
00228                 explorerTableSortColumn = cm.getColumn(viewColumn).getModelIndex();
00229 
00230                 <span class="comment">// update all column headers and repaint header</span>
00231                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> col = 0; col &lt; getColumnCount(); col++) {
00232                     cm.getColumn(col).setHeaderValue(getColumnName(col));
00233                 }
00234                 getTableHeader().repaint();
00235 
00236                 <span class="comment">// update table with sorted data, update selected file and table selection</span>
00237                 setDirectory(directory);
00238             }
00239         });
00240     }
00241 
<a name="l00247"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a2">00247</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> setColumns(<span class="keywordtype">int</span>[] columns) {
00248         <span class="keywordflow">if</span> (columns != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keyword">this</span>.columns = columns;
00249 
00250         <span class="comment">// StructureChanged resets columns' PreferredWidths, so they must be set again...</span>
00251         explorerTableModel.fireTableStructureChanged();
00252 
00253         <span class="comment">// set column default widths. if these are not wide enough, fitColumnWidths() will make them wider.</span>
00254         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> col = 0; col &lt; <span class="keyword">this</span>.columns.length; col++) {
00255             TableColumn column = <span class="keyword">this</span>.getColumnModel().getColumn(col);
00256             <span class="keywordflow">switch</span> (<span class="keyword">this</span>.columns[col]) {
00257             <span class="keywordflow">case</span> COLUMN_FILENAME:
00258                 column.setPreferredWidth(130);
00259                 <span class="keywordflow">break</span>;
00260             <span class="keywordflow">case</span> COLUMN_TYPE:
00261                 column.setMinWidth(55);
00262                 column.setMaxWidth(55);
00263                 <span class="keywordflow">break</span>;
00264             <span class="keywordflow">case</span> COLUMN_LASTMOD:
00265                 column.setMinWidth(95);
00266                 column.setMaxWidth(95);
00267                 <span class="keywordflow">break</span>;
00268             <span class="keywordflow">case</span> COLUMN_LASTMEASURE:
00269                 column.setMinWidth(100);
00270                 column.setMaxWidth(100);
00271                 <span class="keywordflow">break</span>;   <span class="comment">// should be wide enough for dates like "22.12.2005 22:22" with bold font</span>
00272             <span class="keywordflow">case</span> COLUMN_UNMEASURED:
00273                 column.setMinWidth(45);
00274                 column.setMaxWidth(45);
00275                 <span class="keywordflow">break</span>;
00276             }
00277         }
00278     }
00279 
<a name="l00287"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a3">00287</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> fitColumnWidths() {
00288         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> col = 0; col &lt; columns.length; col++) {
00289             <span class="keywordflow">if</span> (columns[col] != COLUMN_FILENAME) {
00290 
00291                 <span class="comment">// find out the column's preferred width using the actual cell contents</span>
00292                 <span class="keywordtype">int</span> width = 0;
00293                 Component comp;
00294                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> row = 0; row &lt; getRowCount(); row++) {
00295                     comp = getCellRenderer(row, col).getTableCellRendererComponent(<span class="keyword">this</span>,
00296                             getValueAt(row, col), <span class="keyword">false</span>, <span class="keyword">false</span>, row, col);
00297                     width = Math.max(width, comp.getPreferredSize().width);
00298                 }
00299                 width += 5;
00300                 <span class="keywordflow">if</span> (columnModel.getColumn(col).getMaxWidth() &lt; width) {
00301                     <span class="comment">// setting min and max width must be done in the event thread</span>
00302                     <span class="keyword">final</span> TableColumn c = columnModel.getColumn(col);
00303                     <span class="keyword">final</span> <span class="keywordtype">int</span> w = width;
00304                     SwingUtilities.invokeLater(<span class="keyword">new</span> Runnable() {
00305                         <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00306                             c.setMaxWidth(w); <span class="comment">// must set max first to avoid "min &gt; max"</span>
00307                             c.setMinWidth(w);
00308                         }
00309                     });
00310                 }
00311             }
00312         }
00313     }
00314 
<a name="l00320"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a4">00320</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> setDirectory(File directory) {
00321         <span class="keyword">this</span>.directory = directory;
00322         <span class="keyword">this</span>.files = getProjectFiles(<span class="keyword">this</span>.directory);
00323 
00324         <span class="comment">// sort files if needed before updating table</span>
00325         <span class="keywordflow">if</span> (explorerTableSortColumn != COLUMN_UNDEFINED) Arrays.sort(files, explorerTableComparator);
00326 
00327         <span class="comment">// search if any file in current directory matches currently open project file</span>
00328         selectedFile = -1;
00329         <span class="keywordflow">if</span> (parent.getProject() != <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00330             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; files.length; n++) {
00331                 <span class="keywordflow">if</span> (parent.getProject().getFile().equals(files[n])) selectedFile = n;
00332             }
00333         }
00334 
00335         <span class="comment">// update table data and selected project file</span>
00336         explorerTableModel.fireTableDataChanged();
00337         <span class="keywordflow">if</span> (selectedFile != -1) {
00338             setRowSelectionInterval(selectedFile, selectedFile);
00339             SwingUtilities.invokeLater(<span class="keyword">new</span> Runnable() {
00340                 <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00341                     scrollToRow(selectedFile);
00342                 }
00343             });
00344         }
00345     }
00346 
<a name="l00352"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#d0">00352</a>     <span class="keyword">private</span> <span class="keywordtype">void</span> scrollToRow(<span class="keywordtype">int</span> <a class="code" href="namespaceikayaki_1_1gui.html#a26a0">rowIndex</a>) {
00353         scrollRectToVisible(getCellRect(rowIndex, rowIndex, <span class="keyword">true</span>));
00354     }
00355 
<a name="l00362"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#d1">00362</a>     <span class="keyword">private</span> File[] getProjectFiles(File directory) {
00363         <span class="keywordflow">if</span> (directory == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> <span class="keyword">new</span> File[0];
00364 
00365         File[] files = directory.listFiles(<span class="keyword">new</span> FileFilter() {
00366             <span class="keyword">public</span> <span class="keywordtype">boolean</span> accept(File file) {
00367                 <span class="keywordflow">return</span> file.isFile() &amp;&amp; file.getName().endsWith(<a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.FILE_TYPE)
00368                         &amp;&amp; (!isCalibration || <a class="code" href="classikayaki_1_1_project.html">Project</a>.getType(file) == <a class="code" href="classikayaki_1_1_project.html">Project</a>.Type.CALIBRATION);
00369             }
00370         });
00371 
00372         <span class="keywordflow">if</span> (files == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> <span class="keyword">new</span> File[0];
00373 
00374         <span class="comment">// build project type cache (Project caches those; we only need to call Project.getType(File) for each file)</span>
00375         <span class="comment">// by doing this, scrolling in a big directory for the first time becomes smoother</span>
00376 
00377         <span class="comment">// stop the old thread before messing with cacheFiles and starting a new thread</span>
00378         <span class="keywordflow">try</span> {
00379             projectTypeCacher.interrupt();
00380             projectTypeCacher.join(); <span class="comment">// wait for old thread to die</span>
00381         } <span class="keywordflow">catch</span> (InterruptedException e) {
00382         }
00383 
00384         <span class="comment">// need a copy of files to work on, as they might get sorted any time in setDirectory(File)</span>
00385         <span class="keyword">final</span> File[] cacheFiles = files.clone();
00386 
00387         projectTypeCacher = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {
00388             <span class="keyword">public</span> <span class="keywordtype">void</span> run() {
00389                 <span class="keywordflow">for</span> (File file : cacheFiles) {
00390                     <span class="keywordflow">if</span> (Thread.interrupted()) <span class="keywordflow">return</span>;
00391                     <span class="keywordflow">if</span> (file.canRead()) Project.getType(file);
00392 
00393                     <span class="comment">// when everything is cached, resize the columns if all data does not fit</span>
00394                     fitColumnWidths();
00395                 }
00396             }
00397         });
00398 
00399         <span class="comment">// start the worker thread</span>
00400         projectTypeCacher.setPriority(Thread.MIN_PRIORITY);
00401         projectTypeCacher.start();
00402 
00403         <span class="keywordflow">return</span> files;
00404     }
00405 
<a name="l00411"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html#a5">00411</a>     <span class="keyword">public</span> <span class="keywordtype">void</span> projectUpdated(<a class="code" href="classikayaki_1_1_project_event.html">ProjectEvent</a> event) {
00412         explorerTableModel.projectUpdated(event);
00413     }
00414 
<a name="l00418"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html">00418</a>     <span class="keyword">private</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html">ProjectExplorerTableModel</a> <span class="keyword">extends</span> AbstractTableModel implements <a class="code" href="interfaceikayaki_1_1_project_listener.html">ProjectListener</a> {
00419 
<a name="l00420"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#r0">00420</a>         <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html">StyledWrapper</a> defaultWrapper = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getDefaultWrapperInstance();
<a name="l00421"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#r1">00421</a>         <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html">StyledWrapper</a> measuringWrapper = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getMeasuringWrapperInstance();
<a name="l00422"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#r2">00422</a>         <span class="keyword">private</span> <span class="keyword">final</span> <a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html">StyledWrapper</a> doneRecentlyWrapper = <a class="code" href="classikayaki_1_1_settings.html">Settings</a>.getDoneRecentlyWrapperInstance();
<a name="l00423"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#r3">00423</a>         <span class="keyword">private</span> <span class="keyword">final</span> Font calibrationNoticeFont = <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">ProjectExplorerTable</a>.this.getFont().deriveFont(Font.BOLD);
00424 
<a name="l00428"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#r4">00428</a>         <span class="keyword">private</span> File measuringProjectFile;
00429 
<a name="l00433"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#r5">00433</a>         <span class="keyword">private</span> File doneRecentlyProjectFile;
00434 
<a name="l00435"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a0">00435</a>         <span class="keyword">public</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html">ProjectExplorerTableModel</a>() {
00436 
00437             <span class="comment">// hide the ugly table borders</span>
00438             Border emptyBorder = BorderFactory.createEmptyBorder(1, 1, 1, 1);
00439             defaultWrapper.border = emptyBorder;
00440             defaultWrapper.selectedBorder = emptyBorder;
00441             defaultWrapper.focusBorder = emptyBorder;
00442             defaultWrapper.selectedFocusBorder = emptyBorder;
00443             measuringWrapper.border = emptyBorder;
00444             measuringWrapper.selectedBorder = emptyBorder;
00445             measuringWrapper.focusBorder = emptyBorder;
00446             measuringWrapper.selectedFocusBorder = emptyBorder;
00447             doneRecentlyWrapper.border = emptyBorder;
00448             doneRecentlyWrapper.selectedBorder = emptyBorder;
00449             doneRecentlyWrapper.focusBorder = emptyBorder;
00450             doneRecentlyWrapper.selectedFocusBorder = emptyBorder;
00451 
00452             <span class="comment">/*</span>
00453 <span class="comment">             * Refresh the data at regular intervals (5 min) even if no other events would refresh it.</span>
00454 <span class="comment">             * This is especially to update the time elapsed value of a calibration panel.</span>
00455 <span class="comment">             */</span>
00456             <span class="keyword">new</span> Timer(5 * 60 * 1000, <span class="keyword">new</span> ActionListener() {
00457                 <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
00458                     <span class="comment">// don't want to mess with table selection, so just update all lines, as this</span>
00459                     <span class="comment">// doesn't mess with table selection (unlike fireTableDataChanged), which is nice :)</span>
00460                     explorerTableModel.fireTableRowsUpdated(0, getRowCount() - 1);
00461                     <span class="comment">// ProjectExplorerTable.this.setDirectory(directory);</span>
00462                 }
00463             }).start();
00464         }
00465 
<a name="l00466"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a1">00466</a>         <span class="keyword">public</span> String getColumnName(<span class="keywordtype">int</span> column) {
00467             <span class="comment">// translate visible column -&gt; all columns for column_name, _not_ for sort column</span>
00468             <span class="comment">// TODO: does this look better without the "*"?</span>
00469             <span class="comment">// - not to me, but don't really care anymore :)</span>
00470             <span class="keywordflow">return</span> column_name[columns[column]] <span class="comment">/* + (column == explorerTableSortColumn ? " *" : "") */</span>;
00471         }
00472 
<a name="l00473"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a2">00473</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> getRowCount() {
00474             <span class="keywordflow">return</span> files.length;
00475         }
00476 
<a name="l00477"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a3">00477</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> getColumnCount() {
00478             <span class="keywordflow">return</span> columns.length;
00479         }
00480 
<a name="l00481"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a4">00481</a>         <span class="keyword">public</span> Object getValueAt(<span class="keywordtype">int</span> row, <span class="keywordtype">int</span> column) {
00482             File file = files[row];
00483             Object <a class="code" href="namespaceikayaki_1_1gui.html#a26a3">value</a>;
00484             <span class="keywordflow">switch</span> (columns[column]) { <span class="comment">// translate visible column -&gt; all columns</span>
00485             <span class="keywordflow">case</span> COLUMN_FILENAME:
00486                 String filename = file.getName();
00487                 value = filename.substring(0, filename.length() - <a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.FILE_TYPE.length());
00488                 <span class="keywordflow">break</span>;
00489             <span class="keywordflow">case</span> COLUMN_TYPE:
00490                 value = <a class="code" href="classikayaki_1_1_project.html">Project</a>.getType(file);
00491                 <span class="keywordflow">break</span>;
00492             <span class="keywordflow">case</span> COLUMN_LASTMOD:
00493                 value = DateFormat.getInstance().format(file.lastModified());
00494 <span class="comment">//                    value = "22.12.2005 22:22"; // testing if this fits to the table</span>
00495                 <span class="keywordflow">break</span>;
00496             <span class="keywordflow">case</span> COLUMN_LASTMEASURE:
00497                 <a class="code" href="classikayaki_1_1_project.html">Project</a> p = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(file);
00498                 <span class="keywordflow">if</span> (p == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00499                     <span class="keywordflow">return</span> <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00500                 }
00501                 Date date = p.<a class="code" href="classikayaki_1_1_project.html#a13">getTimestamp</a>();
00502 <span class="comment">//                    date = new Date(105, 11, 22, 22, 22, 22); // testing if this fits to the table</span>
00503                 <span class="keywordflow">if</span> (date == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00504                     value = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00505                 } <span class="keywordflow">else</span> {
00506                     value = DateFormat.getInstance().format(date);
00507                 }
00508                 <span class="keywordflow">break</span>;
00509             <span class="keywordflow">case</span> COLUMN_UNMEASURED:
00510                 p = <a class="code" href="classikayaki_1_1_project.html">Project</a>.<a class="code" href="classikayaki_1_1_project.html#e5">loadProject</a>(file);
00511                 <span class="keywordflow">if</span> (p == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00512                     <span class="keywordflow">return</span> <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00513                 }
00514                 date = p.<a class="code" href="classikayaki_1_1_project.html#a13">getTimestamp</a>();
00515                 <span class="keywordflow">if</span> (date == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00516                     value = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00517                 } <span class="keywordflow">else</span> {
00518                     value = (<span class="keyword">new</span> Date().getTime() - date.getTime()) / 3600000 + <span class="stringliteral">" h"</span>;
00519                 }
00520                 <span class="keywordflow">break</span>;
00521             <span class="keywordflow">default</span>:
00522                 assert <span class="keyword">false</span>;
00523                 value = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00524                 <span class="keywordflow">break</span>;
00525             }
00526 
00527             <span class="comment">// choose the style according to the project's state</span>
00528             <a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html">StyledWrapper</a> wrapper;
00529             <span class="keywordflow">if</span> (file.equals(measuringProjectFile)) {
00530                 wrapper = measuringWrapper;
00531             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (file.equals(doneRecentlyProjectFile)) {
00532                 wrapper = doneRecentlyWrapper;
00533             } <span class="keywordflow">else</span> {
00534                 wrapper = defaultWrapper;
00535             }
00536             wrapper.<a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html#o13">font</a> = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;        <span class="comment">// reset calibration notice font</span>
00537 
00538             <span class="comment">// styles for the calibration panel</span>
00539             <span class="keywordflow">if</span> (isCalibration) {
00540                 <a class="code" href="classikayaki_1_1_project.html">Project</a> p = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(file);
00541                 <span class="keywordflow">if</span> (p == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00542                     <span class="keywordflow">return</span> <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00543                 }
00544                 Date date = p.<a class="code" href="classikayaki_1_1_project.html#a13">getTimestamp</a>();
00545                 <span class="keywordflow">if</span> (date == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00546                     wrapper.<a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html#o13">font</a> = calibrationNoticeFont;
00547                 } <span class="keywordflow">else</span> {
00548                     <span class="comment">// alert the user if the calibration has not been done today</span>
00549                     <span class="keywordtype">int</span> hoursElapsed = (int) (<span class="keyword">new</span> Date().getTime() - date.getTime()) / 3600000;
00550                     <span class="keywordflow">if</span> (hoursElapsed &gt;= 18) {
00551                         wrapper.<a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html#o13">font</a> = calibrationNoticeFont;
00552                     }
00553                 }
00554             }
00555 
00556             <span class="comment">// return the wrapped value</span>
00557             wrapper.<a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html#o0">value</a> = value;
00558             <span class="keywordflow">return</span> wrapper;
00559         }
00560 
<a name="l00561"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a5">00561</a>         @Override <span class="keyword">public</span> Class&lt;?&gt; getColumnClass(<span class="keywordtype">int</span> columnIndex) {
00562             <span class="keywordflow">return</span> <a class="code" href="classikayaki_1_1gui_1_1_styled_wrapper.html">StyledWrapper</a>.class;
00563         }
00564 
<a name="l00575"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_model.html#a6">00575</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> projectUpdated(<a class="code" href="classikayaki_1_1_project_event.html">ProjectEvent</a> event) {
00576             <span class="keywordflow">if</span> (event.<a class="code" href="classikayaki_1_1_project_event.html#a2">getType</a>() == <a class="code" href="classikayaki_1_1_project_event.html">ProjectEvent</a>.Type.FILE_SAVED) {
00577                 File saved = event.<a class="code" href="classikayaki_1_1_project_event.html#a1">getProject</a>().getFile();
00578                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; files.length; i++) {
00579                     <span class="keywordflow">if</span> (files[i].equals(saved)) {
00580                         explorerTableModel.fireTableRowsUpdated(i, i);
00581                         <span class="keywordflow">return</span>;
00582                     }
00583                 }
00584 
00585             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event.<a class="code" href="classikayaki_1_1_project_event.html#a2">getType</a>() == <a class="code" href="classikayaki_1_1_project_event.html">ProjectEvent</a>.Type.STATE_CHANGED) {
00586                 File file = event.<a class="code" href="classikayaki_1_1_project_event.html#a1">getProject</a>().getFile();
00587                 <span class="keywordtype">boolean</span> repaintTable = <span class="keyword">false</span>;
00588 
00589                 <a class="code" href="classikayaki_1_1_project.html">Project</a>.State state = event.<a class="code" href="classikayaki_1_1_project_event.html#a1">getProject</a>().getState();
00590                 <span class="keywordflow">if</span> (state == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) {
00591                     state = <a class="code" href="classikayaki_1_1_project.html">Project</a>.State.IDLE; <span class="comment">// avoid NullPointerException when recieving events from closed projects</span>
00592                 }
00593                 <span class="keywordflow">switch</span> (state) {
00594                 <span class="keywordflow">case</span> IDLE:
00595                     <span class="keywordflow">if</span> (file.equals(measuringProjectFile)) {
00596                         <span class="comment">// the project's measurement has just ended</span>
00597                         measuringProjectFile = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00598                         doneRecentlyProjectFile = file;
00599                         repaintTable = <span class="keyword">true</span>;
00600                     }
00601                     <span class="keywordflow">break</span>;
00602                 <span class="keywordflow">case</span> MEASURING:
00603                 <span class="keywordflow">case</span> PAUSED:
00604                 <span class="keywordflow">case</span> ABORTED:
00605                     <span class="comment">// the project has an active measurement</span>
00606                     measuringProjectFile = file;
00607                     doneRecentlyProjectFile = <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>;
00608                     repaintTable = <span class="keyword">true</span>;
00609                     <span class="keywordflow">break</span>;
00610                 <span class="keywordflow">default</span>:
00611                     assert <span class="keyword">false</span>;
00612                     <span class="keywordflow">break</span>;
00613                 }
00614 
00615                 <span class="comment">// repaint the table to show updated project states</span>
00616                 <span class="keywordflow">if</span> (repaintTable) {
00617                     <span class="comment">// save the selections, or they will be lost in fireTableDataChanged()</span>
00618                     <span class="keywordtype">int</span>[] selectedRows = <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">ProjectExplorerTable</a>.this.getSelectedRows();
00619                     fireTableDataChanged();
00620                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i : selectedRows) {
00621                         <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">ProjectExplorerTable</a>.this.getSelectionModel().addSelectionInterval(i, i);
00622                     }
00623                 }
00624             }
00625         }
00626     }
00627 
<a name="l00631"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_comparator.html">00631</a>     <span class="keyword">private</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_comparator.html">ProjectExplorerTableComparator</a> <span class="keyword">implements</span> Comparator&lt;File&gt; {
<a name="l00632"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_comparator.html#a0">00632</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> compare(File a, File b) {
00633             <span class="keywordflow">switch</span> (columns[explorerTableSortColumn]) { <span class="comment">// translate sort column</span>
00634             <span class="keywordflow">case</span> COLUMN_FILENAME:
00635                 <span class="keywordflow">return</span> a.compareTo(b);
00636             <span class="keywordflow">case</span> COLUMN_TYPE:
00637                 <span class="comment">// WARNING: might choke Project.getType(File) with O(n log n) requests</span>
00638                 <a class="code" href="classikayaki_1_1_project.html">Project</a>.Type atype = <a class="code" href="classikayaki_1_1_project.html">Project</a>.getType(a), btype = <a class="code" href="classikayaki_1_1_project.html">Project</a>.getType(b);
00639                 <span class="keywordflow">if</span> (atype == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> &amp;&amp; btype == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> 0;
00640                 <span class="keywordflow">if</span> (atype == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> 1;
00641                 <span class="keywordflow">if</span> (btype == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> -1;
00642                 <span class="comment">// NOTE: calibration-projects appear first because of enum-compareTo, but that's just fine, right?</span>
00643                 <span class="keywordflow">return</span> atype.compareTo(btype);
00644             <span class="keywordflow">case</span> COLUMN_LASTMOD:
00645                 <span class="keywordtype">long</span> diff = a.lastModified() - b.lastModified();
00646                 <span class="keywordflow">return</span> diff == 0 ? 0 : (diff &lt; 0 ? -1 : 1);
00647             <span class="keywordflow">case</span> COLUMN_LASTMEASURE:
00648                 <span class="keywordflow">return</span> compareTimestamps(a, b);
00649             <span class="keywordflow">case</span> COLUMN_UNMEASURED:
00650                 <span class="keywordflow">return</span> -compareTimestamps(a, b);
00651             <span class="keywordflow">default</span>:
00652                 <span class="keywordflow">return</span> 0;
00653             }
00654         }
00655 
<a name="l00663"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_table_comparator.html#d0">00663</a>         <span class="keyword">private</span> <span class="keywordtype">int</span> compareTimestamps(File a, File b) {
00664             <a class="code" href="classikayaki_1_1_project.html">Project</a> aproject = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(a);
00665             <a class="code" href="classikayaki_1_1_project.html">Project</a> bproject = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(b);
00666             Date adate = aproject == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> ? <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> : aproject.<a class="code" href="classikayaki_1_1_project.html#a13">getTimestamp</a>();
00667             Date bdate = bproject == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> ? <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> : bproject.<a class="code" href="classikayaki_1_1_project.html#a13">getTimestamp</a>();
00668             <span class="keywordflow">if</span> (adate == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> &amp;&amp; bdate == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> 0;
00669             <span class="keywordflow">if</span> (adate == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> -1;
00670             <span class="keywordflow">if</span> (bdate == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>) <span class="keywordflow">return</span> 1;
00671             <span class="keywordflow">return</span> adate.compareTo(bdate);
00672         }
00673     }
00674 
<a name="l00680"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_popup_menu.html">00680</a>     <span class="keyword">private</span> <span class="keyword">class </span><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_popup_menu.html">ProjectExplorerPopupMenu</a> <span class="keyword">extends</span> JPopupMenu {
00681 
<a name="l00685"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_popup_menu.html#r0">00685</a>         <span class="keyword">private</span> File[] files;
00686 
<a name="l00690"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_popup_menu.html#r1">00690</a>         <span class="keyword">private</span> File directory;
00691 
<a name="l00697"></a><a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_popup_menu.html#a0">00697</a>         <span class="keyword">public</span> <a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table_1_1_project_explorer_popup_menu.html">ProjectExplorerPopupMenu</a>(File[] xfiles) {
00698             <span class="keywordflow">if</span> (xfiles == <a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a> || xfiles.length == 0) <span class="keywordflow">return</span>; <span class="comment">// stupid caller</span>
00699 
00700             <span class="keyword">this</span>.files = xfiles;
00701             <span class="keyword">this</span>.directory = files[0].getParentFile();
00702 
00703             String filename, basename;
00704             <span class="keywordflow">if</span> (files.length == 1) {
00705                 filename = files[0].getName();
00706                 basename = filename;
00707                 <span class="keywordflow">if</span> (basename.toLowerCase().endsWith(<a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.FILE_TYPE)) {
00708                     basename = basename.substring(0, basename.length() - <a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.FILE_TYPE.length());
00709                 }
00710             } <span class="keywordflow">else</span> {
00711                 filename = <span class="stringliteral">"selected "</span> + files.length + <span class="stringliteral">" files"</span>;
00712                 basename = <span class="stringliteral">"*"</span>;
00713             }
00714 
00715             JMenuItem export = <span class="keyword">new</span> JMenuItem(<span class="stringliteral">"Export "</span> + filename + <span class="stringliteral">" to"</span>);
00716             export.setFont(export.getFont().deriveFont(Font.BOLD));
00717             export.setEnabled(<span class="keyword">false</span>);
00718             <span class="keyword">this</span>.add(export);
00719 
00720             <span class="comment">// TODO: some portable way to get a File for disk drive? Or maybe a Setting for export-dirs?</span>
00721             <span class="keywordflow">for</span> (File dir : <span class="keyword">new</span> File[]{<a class="code" href="namespaceikayaki_1_1gui.html#a26a2">null</a>, directory, <span class="keyword">new</span> File(<span class="stringliteral">"A:/"</span>)}) {
00722                 <span class="keywordflow">for</span> (String type : <span class="keyword">new</span> String[]{<span class="stringliteral">"dat"</span>, <span class="stringliteral">"tdt"</span>, <span class="stringliteral">"srm"</span>}) {
00723                     JMenuItem exportitem;
00724                     <span class="keywordflow">if</span> (dir == null) {
00725                         exportitem = <span class="keyword">new</span> JMenuItem(type.toUpperCase() + <span class="stringliteral">" file"</span> +
00726                                 (files.length &gt; 1 ? <span class="stringliteral">"s"</span> : <span class="stringliteral">""</span>) + <span class="stringliteral">"..."</span>);
00727                     } <span class="keywordflow">else</span> {
00728                         exportitem = <span class="keyword">new</span> JMenuItem(<span class="keyword">new</span> File(dir, basename + <span class="stringliteral">"."</span> + type).toString());
00729                     }
00730 
00731                     <span class="keyword">this</span>.add(exportitem);
00732 
00737                     exportitem.addActionListener(<span class="keyword">new</span> ActionListener() {
00738                         <span class="keyword">public</span> <span class="keywordtype">void</span> actionPerformed(ActionEvent e) {
00739                             String filename = e.getActionCommand();
00740                             String filetype = filename.substring(filename.length() - 3);
00741                             File exportdir;
00742                             <span class="keywordtype">boolean</span> dirHasFile = <span class="keyword">false</span>;
00743 
00744                             <span class="keywordflow">if</span> (filetype.equals(<span class="stringliteral">"..."</span>)) {
00745                                 filetype = filename.substring(0, 3).toLowerCase();
00746                                 JFileChooser chooser = <span class="keyword">new</span> JFileChooser(directory);
00747 
00748                                 <span class="keywordflow">if</span> (files.length &gt; 1) {
00749                                     chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
00750                                 } <span class="keywordflow">else</span> {
00751                                     dirHasFile = <span class="keyword">true</span>; <span class="comment">// we have explicit export-filename in exportdir</span>
00752                                 }
00753 
00754                                 chooser.setFileFilter(
00755                                         <span class="keyword">new</span> <a class="code" href="classikayaki_1_1gui_1_1_generic_file_filter.html">GenericFileFilter</a>(filetype.toUpperCase() + <span class="stringliteral">" File"</span>, filetype));
00756 
00757                                 <span class="keywordflow">if</span> (chooser.showSaveDialog(<a class="code" href="classikayaki_1_1gui_1_1_project_explorer_table.html">ProjectExplorerTable</a>.this) == JFileChooser.APPROVE_OPTION) {
00758                                     exportdir = chooser.getSelectedFile();
00759                                 } <span class="keywordflow">else</span> {
00760                                     <span class="keywordflow">return</span>;
00761                                 }
00762 
00763                             } <span class="keywordflow">else</span> {
00764                                 exportdir = <span class="keyword">new</span> File(filename).getParentFile();
00765                             }
00766 
00767                             <span class="comment">// execute export</span>
00768                             <span class="keywordflow">for</span> (File f : files) {
00769 
00770                                 <span class="comment">/* TODO: This overwrites existing files without asking!</span>
00771 <span class="comment">                                 *</span>
00772 <span class="comment">                                 * Get a pointer to MainViewPanel and use the method</span>
00773 <span class="comment">                                 * MainViewPanel.exportProject(Project,String,File)</span>
00774 <span class="comment">                                 * because it prompts the user if the file exists, and</span>
00775 <span class="comment">                                 * offers the option to change the output file name.</span>
00776 <span class="comment">                                 *</span>
00777 <span class="comment">                                 * Another option is to automatically rename the new file</span>
00778 <span class="comment">                                 * to file.0.dat, file.1.dat and so on.</span>
00779 <span class="comment">                                 */</span>
00780 
00781                                 File exportfile;
00782                                 <span class="keywordflow">if</span> (dirHasFile) {
00783                                     exportfile = exportdir;
00784                                     <span class="keywordflow">if</span> (!exportfile.getName().toLowerCase().endsWith(<span class="stringliteral">"."</span> + filetype)) {
00785                                         exportfile = <span class="keyword">new</span> File(exportfile.toString() + <span class="stringliteral">"."</span> + filetype);
00786                                     }
00787                                 } <span class="keywordflow">else</span> {
00788                                     String exportname = f.getName();
00789                                     <span class="keywordflow">if</span> (exportname.toLowerCase().endsWith(<a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.FILE_TYPE)) {
00790                                         exportname = exportname.substring(0,
00791                                                 exportname.length() - <a class="code" href="classikayaki_1_1_ikayaki.html">Ikayaki</a>.FILE_TYPE.length());
00792                                     }
00793                                     exportname += <span class="stringliteral">"."</span> + filetype;
00794                                     exportfile = <span class="keyword">new</span> File(exportdir, exportname);
00795                                 }
00796 
00797 <span class="comment">//                                System.out.print("Exporting " + exportfile + "... ");</span>
00798 
00799                                 <span class="keywordtype">boolean</span> ok = <span class="keyword">false</span>;
00800                                 <span class="keywordflow">if</span> (filetype.equals(<span class="stringliteral">"dat"</span>)) {
00801                                     ok = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(f).exportToDAT(exportfile);
00802                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (filetype.equals(<span class="stringliteral">"tdt"</span>)) {
00803                                     ok = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(f).exportToTDT(exportfile);
00804                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (filetype.equals(<span class="stringliteral">"srm"</span>)) ok = <a class="code" href="classikayaki_1_1_project.html">Project</a>.loadProject(f).exportToSRM(exportfile);
00805 
00806 <span class="comment">//                                System.out.println(ok ? "ok" : "ERROR");</span>
00807 <span class="comment">/*</span>
00808 <span class="comment">                                // TODO: tell somehow, not with popup, if export was successful; statusbar perhaps?</span>
00809 <span class="comment">                                Component c = ProjectExplorerTable.this;</span>
00810 <span class="comment">                                while (c.getParent() != null) c = c.getParent();</span>
00811 <span class="comment">                                if (!ok) JOptionPane.showMessageDialog(c, "Unable to write to " + exportfile,</span>
00812 <span class="comment">                                                                       "Error exporting files", JOptionPane.ERROR_MESSAGE);</span>
00813 <span class="comment">*/</span>
00814                             }
00815                         }
00816                     });
00817                 }
00818             }
00819         }
00820     }
00821 } <span class="comment">// NOTE: what a nice end-brace-fallout :)</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed May 4 13:11:04 2005 for Squid by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
